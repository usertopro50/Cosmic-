<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG V5: Cosmic</title>
    <style>
        :root {
            --bg: #050505; --panel: #111; --border: #222;
            --prim: #3498db; --sec: #9b59b6; --acc: #f1c40f; --dang: #e74c3c;
            --rare-1: #95a5a6; --rare-2: #3498db; --rare-3: #9b59b6; --rare-4: #f1c40f; --rare-5: #e84393;
        }
        body { background: var(--bg); color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER HUD */
        .hud { background: rgba(10,10,10,0.95); padding: 8px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); z-index: 10; font-size: 12px; font-weight: bold; }
        .res-grp { display: flex; gap: 12px; align-items: center; }
        .res { display: flex; align-items: center; gap: 4px; background: #222; padding: 3px 8px; border-radius: 4px; }
        .res span { color: #fff; }

        /* MAIN CONTENT & TABS */
        .viewport { flex: 1; position: relative; overflow: hidden; background: radial-gradient(circle at bottom, #1a1a1a, #000); }
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; overflow-y: auto; padding-bottom: 80px; }
        .screen.show { display: flex; }

        /* BATTLE ARENA */
        .arena { flex: 1; display: flex; justify-content: space-evenly; align-items: center; position: relative; perspective: 800px; }
        .fighter { width: 100px; text-align: center; position: relative; transition: transform 0.1s; }
        .f-icon { font-size: 70px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7)); display: inline-block; }
        .pet-slot { position: absolute; left: -30px; bottom: 0px; font-size: 30px; animation: float 3s infinite ease-in-out; }
        
        /* BARS */
        .bar-wrap { width: 100%; background: #000; height: 6px; border-radius: 3px; margin-top: 6px; position: relative; overflow: hidden; border: 1px solid #333; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        .hp { background: linear-gradient(90deg, #ff7675, #d63031); }
        .mp { background: linear-gradient(90deg, #74b9ff, #0984e3); }
        .xp-line { height: 3px; background: #222; width: 100%; }
        .xp-val { height: 100%; background: var(--acc); width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--acc); }

        /* CONTROLS */
        .ctrl-panel { padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: rgba(10,10,10,0.9); border-top: 1px solid var(--border); backdrop-filter: blur(5px); }
        .btn { border: none; border-radius: 6px; height: 50px; color: #fff; font-weight: 800; font-size: 11px; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #333; box-shadow: 0 4px 0 rgba(0,0,0,0.4); }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-cd { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(0,0,0,0.6); }
        
        .b-atk { grid-column: span 2; background: #d63031; font-size: 14px; }
        .b-spec { background: #6c5ce7; }
        .b-util { background: #00b894; }
        .b-wide { grid-column: span 4; height: 30px; margin-top: 5px; background: #636e72; flex-direction: row; gap: 8px; }
        .b-wide.active { background: #fdcb6e; color: #000; box-shadow: 0 0 15px #fdcb6e; }
                /* MINING & GRIDS */
        .mine-box { text-align: center; padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .rock { font-size: 100px; cursor: pointer; transition: 0.1s; filter: drop-shadow(0 0 20px #555); }
        .rock:active { transform: scale(0.9) rotate(5deg); }
        
        .grid-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; }
        .card-item { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; position: relative; }
        .card-item.bought { border-color: var(--acc); background: #222; }
        
        /* UPGRADE LIST */
        .upg-row { display: flex; justify-content: space-between; align-items: center; background: #151515; margin-bottom: 8px; padding: 10px; border-radius: 6px; border-left: 3px solid #555; }
        .upg-btn { background: var(--prim); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 11px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-c { background: #111; width: 85%; max-width: 320px; border-radius: 10px; padding: 20px; border: 1px solid #333; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        /* FX */
        .floater { position: absolute; font-weight: 900; font-size: 20px; pointer-events: none; text-shadow: 0 2px 0 #000; z-index: 50; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0% { transform: translate(0,0); } 20% { transform: translate(-4px, 2px); } 40% { transform: translate(4px, -2px); } 100% { transform: translate(0,0); } }
        .shake { animation: shake 0.3s; }

        /* NAV */
        .nav { display: flex; height: 65px; background: #0a0a0a; border-top: 1px solid #222; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 10px; font-weight: bold; transition: 0.2s; }
        .nav-btn i { font-size: 20px; margin-bottom: 3px; font-style: normal; }
        .nav-btn.active { color: var(--acc); background: rgba(255,255,255,0.02); border-top: 2px solid var(--acc); }
        .nav-btn.active i { transform: scale(1.2); }
    </style>
</head>
<body>
    <div id="modal" class="modal">
        <div class="modal-c">
            <div style="text-align:right; font-size:24px; cursor:pointer" onclick="ui.close()">√ó</div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="app">
        <div class="hud">
            <div class="res-grp">
                <div class="res"><span style="color:#f1c40f">üåï</span> <span id="hud-gold">0</span></div>
                <div class="res"><span style="color:#e84393">üíé</span> <span id="hud-gem">0</span></div>
            </div>
            <div class="res-grp">
                <span style="color:#3498db">LVL <span id="hud-lvl">1</span></span>
            </div>
        </div>
        <div class="xp-line"><div id="xp-bar" class="xp-val"></div></div>

        <div class="viewport">
            <div id="tab-fight" class="screen show">
                <div style="text-align:center; padding-top:10px; color:#666; font-size:10px; letter-spacing:1px;">ZONE <span id="hud-stage">1</span></div>
                
                <div class="arena" id="arena">
                    <div class="fighter" id="hero">
                        <div class="f-icon">üßô‚Äç‚ôÇÔ∏è</div>
                        <div class="pet-slot" id="pet-display"></div>
                        <div class="bar-wrap"><div id="bar-hp" class="bar-fill hp"></div></div>
                        <div class="bar-wrap" style="height:4px"><div id="bar-mp" class="bar-fill mp"></div></div>
                    </div>
                    <div class="fighter" id="enemy">
                        <div id="e-icon" class="f-icon">üë∫</div>
                        <div class="bar-wrap"><div id="bar-ehp" class="bar-fill hp"></div></div>
                        <div id="boss-ui" style="display:none; color:#e74c3c; font-weight:bold; font-size:10px; margin-top:4px">‚è≥ <span id="boss-timer">30</span>s</div>
                    </div>
                </div>

                <div class="ctrl-panel">
                    <button class="btn b-atk" onclick="combat.click()">
                        ‚öîÔ∏è ATTACK
                    </button>
                    <button class="btn b-spec" onclick="combat.skill('blast')">
                        üî• BLAST <small>15 MP</small>
                        <div class="btn-cd" id="cd-blast"></div>
                    </button>
                    <button class="btn b-util" onclick="combat.skill('heal')">
                        üíö HEAL <small>20 MP</small>
                        <div class="btn-cd" id="cd-heal"></div>
                    </button>
                    <button id="btn-auto" class="btn b-wide" onclick="combat.toggleAuto()">
                        <span>ü§ñ</span> AUTO-FIGHT
                    </button>
                </div>
            </div>
                        <div id="tab-upg" class="screen" style="padding:15px">
                <div style="text-align:center; margin-bottom:15px">
                    <h2 style="margin:0; color:#3498db">UPGRADES</h2>
                    <small style="color:#777">Boost your power</small>
                </div>
                <div id="list-upg"></div>
                
                <h3 style="color:#e84393; margin-top:20px">üíé GEM SHOP</h3>
                <div class="grid-box" id="list-gem"></div>
            </div>

            <div id="tab-mine" class="screen">
                <div class="mine-box">
                    <h3 style="color:#f1c40f">DEEP MINE</h3>
                    <div style="font-size:12px; color:#aaa; margin-bottom:20px">Tap Rock -> Get Ore -> Craft Gems</div>
                    
                    <div id="rock" class="rock" onclick="mining.hit()">ü™®</div>
                    
                    <div style="margin-top:30px; background:#222; padding:10px; border-radius:8px; width:80%">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                            <span>üì¶ Ore: <span id="mine-ore">0</span></span>
                            <span>‚õèÔ∏è Lvl: <span id="mine-lvl">1</span></span>
                        </div>
                        <div class="bar-wrap"><div id="rock-bar" class="bar-fill hp" style="background:#7f8c8d"></div></div>
                    </div>
                    
                    <button class="btn" onclick="mining.craft()" style="width:80%; margin-top:20px; background:#e67e22">
                        ‚öíÔ∏è CRAFT GEM (100 Ore)
                    </button>
                </div>
            </div>

            <div id="tab-pet" class="screen" style="padding:15px">
                <div style="text-align:center; padding:10px; background:#1a1a1a; border-radius:8px; margin-bottom:15px">
                    <h2 style="margin:0; color:#2ecc71">PET HATCHERY</h2>
                    <p style="font-size:11px">Pets attack automatically!</p>
                    <button class="btn" onclick="pets.hatch()" style="width:100%; background:#27ae60">
                        ü•ö HATCH EGG (500g)
                    </button>
                </div>
                <div id="list-pets" class="grid-box" style="grid-template-columns:repeat(3, 1fr)"></div>
                
                <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px">
                    <button class="btn" style="background:#444; width:100%" onclick="game.hardReset()">‚ò†Ô∏è WIPE SAVE</button>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-btn active" onclick="ui.tab('fight', this)"><i>‚öîÔ∏è</i>BATTLE</div>
            <div class="nav-btn" onclick="ui.tab('upg', this)"><i>üí™</i>POWER</div>
            <div class="nav-btn" onclick="ui.tab('mine', this)"><i>‚õèÔ∏è</i>MINE</div>
            <div class="nav-btn" onclick="ui.tab('pet', this)"><i>üêâ</i>PETS</div>
        </div>
    </div>
</body>
<script>
/* --- CONFIG & DATA --- */
const C = {
    ver: 'rpg_v5_cosmic',
    upgrades: [
        {id:'dmg', n:'Sharpness', base:50, m:1.5, desc:'+2 Base Dmg'},
        {id:'hp', n:'Vitality', base:50, m:1.5, desc:'+20 Base HP'},
        {id:'regen', n:'Regeneration', base:200, m:1.8, desc:'+1 HP/sec'},
        {id:'greed', n:'Greed', base:500, m:2.0, desc:'+10% Gold'}
    ],
    gemShop: [
        {id:'g_dmg', n:'Power', cost:5, desc:'+50% DMG'},
        {id:'g_xp', n:'Wisdom', cost:5, desc:'+50% XP'},
        {id:'g_auto', n:'Bot', cost:10, desc:'Auto-Miner'}
    ],
    mobs: ["üêÄ","ü¶á","üê∫","ü¶Ç","üêç","üßü","üíÄ","üëπ","üë∫","üê≤","üëΩ","üëæ"]
};

let G = { // SAVE DATA
    gold: 0, gems: 0, lvl: 1, xp: 0, max_xp: 100, stage: 1,
    stats: { dmg: 10, hp: 100, mp: 50 },
    upg: { dmg:0, hp:0, regen:0, greed:0 }, // Upgrade Levels
    perm: { g_dmg:0, g_xp:0, g_auto:0 }, // Gem Upgrades
    mine: { ore:0, lvl:1, xp:0 },
    pets: [], // Array of owned pets
    activePet: null
};

let S = { // RUNTIME STATE
    hp: 100, mp: 50, m_hp: 50, m_max: 50,
    rock_hp: 10, rock_max: 10,
    cd: { blast:0, heal:0 },
    auto: false,
    boss_tmr: null,
    ticks: 0
};

const game = {
    start: () => {
        game.load();
        game.recalc();
        S.hp = G.stats.hp;
        combat.spawn();
        ui.init();
        
        // GAME LOOP (100ms tick)
        setInterval(() => {
            S.ticks++;
            // Resources
            if(S.mp < G.stats.mp && S.ticks%10===0) S.mp += 1; // MP Regen
            if(G.upg.regen > 0 && S.ticks%10===0) S.hp = Math.min(G.stats.hp, S.hp + G.upg.regen); // HP Regen
            
            // Cooldowns
            if(S.cd.blast > 0) S.cd.blast -= 100;
            if(S.cd.heal > 0) S.cd.heal -= 100;
            
            // Automation
            if(S.auto && S.m_hp > 0 && S.ticks%5===0) combat.hit('auto');
            if(G.perm.g_auto > 0 && S.ticks%20===0) mining.hit(true); // Auto Mine
            
            // Pets (Attack every 2s)
            if(G.activePet && S.ticks%20===0 && S.m_hp > 0) {
                let pdmg = Math.floor(G.stats.dmg * 0.5);
                combat.deal(pdmg, '#2ecc71');
            }
            
            // Save
            if(S.ticks % 100 === 0) game.save();
            
            ui.loop();
        }, 100);
    },
    
    recalc: () => {
        // Base
        let d = 10 + (G.upg.dmg * 2) + (G.lvl * 2);
        let h = 100 + (G.upg.hp * 20) + (G.lvl * 10);
        
        // Multipliers
        if(G.perm.g_dmg) d *= 1.5;
        
        G.stats.dmg = Math.floor(d);
        G.stats.hp = Math.floor(h);
    },

    save: () => localStorage.setItem(C.ver, JSON.stringify(G)),
    load: () => {
        let d = localStorage.getItem(C.ver);
        if(d) G = {...G, ...JSON.parse(d)};
    },
    hardReset: () => {
        if(confirm("DELETE EVERYTHING?")) {
            localStorage.removeItem(C.ver);
            location.reload();
        }
    }
};
const combat = {
    spawn: () => {
        let isBoss = G.stage % 5 === 0;
        let base = 40 + (G.stage * 15);
        S.m_max = Math.floor(base * (isBoss ? 4 : 1));
        S.m_hp = S.m_max;
        
        let ico = isBoss ? "üëπ" : C.mobs[G.stage % C.mobs.length];
        document.getElementById('e-icon').innerText = ico;
        
        if(isBoss) combat.bossTimer(30);
        else document.getElementById('boss-ui').style.display = 'none';
        
        ui.updateMob();
    },
    
    bossTimer: (sec) => {
        let ui = document.getElementById('boss-ui');
        let txt = document.getElementById('boss-timer');
        ui.style.display = 'block';
        clearInterval(S.boss_tmr);
        let t = sec;
        txt.innerText = t;
        
        S.boss_tmr = setInterval(() => {
            t--; txt.innerText = t;
            if(t <= 0) {
                clearInterval(S.boss_tmr);
                fx.float("FAILED", "#e74c3c", "enemy");
                combat.spawn(); // Reset
            }
        }, 1000);
    },

    hit: (src) => {
        if(S.m_hp <= 0 || S.hp <= 0) return;
        combat.deal(G.stats.dmg, '#fff');
        if(src !== 'auto') ui.anim('enemy', 'shake');
    },
    
    skill: (type) => {
        if(type === 'blast') {
            if(S.mp < 15 || S.cd.blast > 0) return;
            S.mp -= 15; S.cd.blast = 3000;
            combat.deal(G.stats.dmg * 4, '#f1c40f');
            fx.float("BLAST!", "#f1c40f", "hero");
        }
        if(type === 'heal') {
            if(S.mp < 20 || S.cd.heal > 0) return;
            S.mp -= 20; S.cd.heal = 5000;
            let h = Math.floor(G.stats.hp * 0.4);
            S.hp = Math.min(G.stats.hp, S.hp + h);
            fx.float("+"+h, "#2ecc71", "hero");
        }
    },

    deal: (amt, col) => {
        // Crit?
        if(Math.random() < 0.2) { amt *= 2; col = "#e84393"; }
        
        S.m_hp -= amt;
        fx.float(amt, col, 'enemy');
        
        if(S.m_hp <= 0) combat.win();
        else if(Math.random() < 0.3) combat.enemyHit(); // 30% chance enemy counters
    },

    enemyHit: () => {
        if(S.m_hp <= 0) return;
        let dmg = Math.floor(G.stage * 1.5) + 2;
        S.hp -= dmg;
        fx.float("-"+dmg, "#e74c3c", "hero");
        if(S.hp <= 0) {
            fx.float("DEAD", "#c0392b", "hero");
            S.hp = G.stats.hp;
            combat.spawn(); // Reset stage
            if(S.auto) combat.toggleAuto();
        }
    },

    win: () => {
        clearInterval(S.boss_tmr);
        let gold = Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1));
        let xp = 20 + (G.stage * 5);
        if(G.perm.g_xp) xp *= 1.5;
        
        G.gold += gold;
        G.xp += xp;
        fx.float("+"+gold+"g", "#f1c40f", "hero");
        
        // Gem Drop (1% boss, 0.1% normal)
        let chance = (G.stage % 5 === 0) ? 0.05 : 0.001;
        if(Math.random() < chance) {
            G.gems++;
            fx.float("üíé GEM!", "#e84393", "hero");
        }

        if(G.xp >= G.max_xp) {
            G.lvl++; G.xp=0; G.max_xp *= 1.2;
            game.recalc();
            S.hp = G.stats.hp; // Full Heal
            fx.float("LEVEL UP!", "#3498db", "hero");
        }
        
        G.stage++;
        setTimeout(combat.spawn, 800);
    },
    
    toggleAuto: () => {
        S.auto = !S.auto;
        document.getElementById('btn-auto').classList.toggle('active');
    }
};
const mining = {
    hit: (auto) => {
        if(S.rock_hp <= 0) return;
        let dmg = 1 + G.mine.lvl;
        S.rock_hp -= dmg;
        if(!auto) {
            ui.anim('rock', 'shake');
            fx.float(dmg, '#aaa', 'rock');
        }
        
        if(S.rock_hp <= 0) {
            G.mine.ore += (1 + Math.floor(Math.random() * G.mine.lvl));
            fx.float("+Ore", "#aaa", "rock");
            S.rock_max *= 1.1;
            S.rock_hp = S.rock_max;
        }
        ui.renderMine();
    },
    craft: () => {
        if(G.mine.ore >= 100) {
            G.mine.ore -= 100;
            G.gems++;
            fx.float("+1 üíé", "#e84393", "rock");
            ui.renderMine();
        } else alert("Need 100 Ore!");
    }
};

const pets = {
    hatch: () => {
        if(G.gold >= 500) {
            G.gold -= 500;
            let mobs = ["Bat", "Slime", "Wolf", "Ghost"];
            let p = {
                n: mobs[Math.floor(Math.random()*mobs.length)],
                dmg: 5 + (G.stage)
            };
            G.pets.push(p);
            // Auto equip if none
            if(!G.activePet) G.activePet = p;
            ui.renderPets();
            alert(`Hatched a ${p.n}!`);
        } else alert("Need 500g");
    },
    equip: (idx) => {
        G.activePet = G.pets[idx];
        ui.renderPets();
    }
};
const ui = {
    init: () => {
        // Build Upgrade List
        let l = document.getElementById('list-upg');
        C.upgrades.forEach(u => {
            let d = document.createElement('div');
            d.className = 'upg-row';
            d.innerHTML = `
                <div>
                    <div style="color:#fff; font-weight:bold">${u.n} <small style="color:#3498db">Lvl <span id="u_lvl_${u.id}">0</span></small></div>
                    <div style="font-size:10px; color:#777">${u.desc}</div>
                </div>
                <button class="upg-btn" onclick="ui.buyUpg('${u.id}')">
                    <span id="u_cost_${u.id}">0</span>g
                </button>
            `;
            l.appendChild(d);
        });
        ui.renderPets();
        ui.renderMine();
    },
    
    loop: () => {
        // Header
        document.getElementById('hud-gold').innerText = Math.floor(G.gold);
        document.getElementById('hud-gem').innerText = G.gems;
        document.getElementById('hud-lvl').innerText = G.lvl;
        document.getElementById('hud-stage').innerText = G.stage;
        
        // Bars
        document.getElementById('bar-hp').style.width = (S.hp/G.stats.hp*100)+"%";
        document.getElementById('bar-mp').style.width = (S.mp/G.stats.mp*100)+"%";
        document.getElementById('bar-ehp').style.width = (S.m_hp/S.m_max*100)+"%";
        document.getElementById('xp-bar').style.width = (G.xp/G.max_xp*100)+"%";
        
        // Cooldowns
        document.getElementById('cd-blast').style.height = (S.cd.blast/3000*100)+"%";
        document.getElementById('cd-heal').style.height = (S.cd.heal/5000*100)+"%";
        
        // Upgrade Texts
        C.upgrades.forEach(u => {
            let lvl = G.upg[u.id];
            let cost = Math.floor(u.base * Math.pow(u.m, lvl));
            document.getElementById(`u_lvl_${u.id}`).innerText = lvl;
            document.getElementById(`u_cost_${u.id}`).innerText = cost;
        });
    },

    buyUpg: (id) => {
        let u = C.upgrades.find(x => x.id === id);
        let lvl = G.upg[id];
        let cost = Math.floor(u.base * Math.pow(u.m, lvl));
        if(G.gold >= cost) {
            G.gold -= cost;
            G.upg[id]++;
            game.recalc();
        }
    },
    
    renderMine: () => {
        document.getElementById('mine-ore').innerText = G.mine.ore;
        document.getElementById('mine-lvl').innerText = G.mine.lvl;
        document.getElementById('rock-bar').style.width = (S.rock_hp/S.rock_max*100)+"%";
    },

    renderPets: () => {
        let d = document.getElementById('list-pets');
        d.innerHTML = "";
        G.pets.forEach((p, i) => {
            let el = document.createElement('div');
            el.className = 'card-item ' + (G.activePet === p ? 'bought' : '');
            el.innerHTML = `<div style="font-size:24px">ü•ö</div><div>${p.n}</div><div style="font-size:10px; color:#777">${p.dmg} DMG</div>`;
            el.onclick = () => pets.equip(i);
            d.appendChild(el);
        });
        if(G.activePet) document.getElementById('pet-display').innerText = "üêâ";
    },
    
    updateMob: () => { /* handled in loop mainly */ },
    
    anim: (id, cls) => {
        let el = document.getElementById(id);
        el.classList.remove(cls);
        void el.offsetWidth;
        el.classList.add(cls);
    },
    
    tab: (id, btn) => {
        document.querySelectorAll('.screen').forEach(e=>e.classList.remove('show'));
        document.getElementById('tab-'+id).classList.add('show');
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        btn.classList.add('active');
    },
    close: () => document.getElementById('modal').style.display='none'
};

const fx = {
    float: (txt, col, parentId) => {
        let p = document.getElementById(parentId);
        let el = document.createElement('div');
        el.className = 'floater';
        el.innerText = txt; 
        el.style.color = col;
        let r = (Math.random()*40)-20;
        el.style.left = (p.offsetLeft + 40 + r) + "px";
        el.style.top = p.offsetTop + "px";
        document.querySelector('.viewport').appendChild(el);
        
        let y = 0;
        let op = 1;
        let int = setInterval(() => {
            y -= 2; op -= 0.05;
            el.style.transform = `translateY(${y}px)`;
            el.style.opacity = op;
            if(op<=0) { clearInterval(int); el.remove(); }
        }, 50);
    }
};

game.start();
</script>
</body>
<script>
// 1. INJECT V7 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* MAGIC TAB STYLES */
    .rune-box { display: flex; justify-content: space-around; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
    .rune { text-align: center; font-weight: bold; }
    .rune-icon { font-size: 24px; display: block; margin-bottom: 5px; filter: drop-shadow(0 0 5px currentColor); }
    
    .spell-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .spell-card { background: #1a1a1a; padding: 15px; border: 1px solid #333; border-radius: 8px; cursor: pointer; position: relative; overflow: hidden; }
    .spell-card:active { transform: scale(0.98); }
    .spell-card.maxed { border-color: #f1c40f; opacity: 0.7; }
    
    /* QUEST STYLES */
    .quest-row { background: #0f0f0f; padding: 12px; margin-bottom: 8px; border-left: 4px solid #777; display: flex; justify-content: space-between; align-items: center; }
    .quest-row.done { border-color: #2ecc71; opacity: 0.5; text-decoration: line-through; }
    
    /* AURA FX */
    .aura-fire { box-shadow: 0 0 15px #e74c3c, inset 0 0 10px #e74c3c; animation: pulse 2s infinite; border-radius: 50%; }
    .aura-ice { border: 2px solid #74b9ff; box-shadow: 0 0 10px #74b9ff; }
</style>
`);

// 2. INJECT NEW SCREENS
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-magic" class="screen" style="padding:15px">
        <div style="text-align:center; margin-bottom:15px">
            <h2 style="color:#a29bfe; margin:0">GRIMOIRE</h2>
            <small>Collect Runes -> Craft Passives</small>
        </div>

        <div class="rune-box">
            <div class="rune" style="color:#e74c3c"><span class="rune-icon">üî•</span> <span id="r-fire">0</span></div>
            <div class="rune" style="color:#74b9ff"><span class="rune-icon">‚ùÑÔ∏è</span> <span id="r-ice">0</span></div>
            <div class="rune" style="color:#f1c40f"><span class="rune-icon">‚ö°</span> <span id="r-storm">0</span></div>
        </div>

        <div id="spell-list" class="spell-grid"></div>

        <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
            <h3 style="color:#2ecc71">üìú DAILY QUESTS</h3>
            <div id="quest-list"></div>
            <button class="btn" style="width:100%; margin-top:10px; background:#333" onclick="quests.refresh()">Refresh Quests (1 Gem)</button>
        </div>
    </div>
`);

// 3. INJECT NAV
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('magic', this)"><i>üîÆ</i>MAGIC</div>
`);

// 4. DATA & LOGIC
const magic = {
    spells: [
        {id:'s_atk', n:'Flame Aura', type:'fire', cost:10, desc:'+5% Damage', max:10, stat:'dmg', val:0.05},
        {id:'s_hp', n:'Ice Barrier', type:'ice', cost:10, desc:'+5% Health', max:10, stat:'hp', val:0.05},
        {id:'s_gold', n:'Greed Spark', type:'storm', cost:10, desc:'+5% Gold', max:10, stat:'gold', val:0.05}
    ],
    craft: (idx) => {
        let s = magic.spells[idx];
        let lvl = G.spells[s.id] || 0;
        
        if(lvl >= s.max) return alert("Max Level Reached!");
        
        let cost = s.cost * (lvl + 1);
        let res = G.runes[s.type];
        
        if(res >= cost) {
            G.runes[s.type] -= cost;
            G.spells[s.id] = lvl + 1;
            fx.float("LEARNED!", "#a29bfe", "spell-list");
            magic.applyAura(s.type);
            game.recalc(); // Recalculate stats
            ui.renderMagic();
        } else {
            alert(`Need ${cost} ${s.type.toUpperCase()} Runes`);
        }
    },
    applyAura: (type) => {
        let h = document.getElementById('hero');
        if(type === 'fire') h.classList.add('aura-fire');
        if(type === 'ice') h.classList.add('aura-ice');
    }
};

const quests = {
    types: ['kill', 'click', 'gold'],
    gen: () => {
        G.quests = [];
        for(let i=0; i<3; i++) {
            let type = quests.types[Math.floor(Math.random()*quests.types.length)];
            let target = 10 * G.lvl;
            if(type === 'click') target = 50;
            if(type === 'gold') target = 1000 * G.lvl;
            
            G.quests.push({
                desc: type==='kill' ? `Defeat ${target} Enemies` : (type==='click' ? `Click Attack ${target}x` : `Earn ${target} Gold`),
                type: type,
                max: target,
                cur: 0,
                done: false,
                rew: 5 + Math.floor(G.lvl/5)
            });
        }
        ui.renderQuests();
    },
    check: (type, amt) => {
        if(!G.quests) return;
        let changed = false;
        G.quests.forEach(q => {
            if(!q.done && q.type === type) {
                q.cur += amt;
                if(q.cur >= q.max) {
                    q.cur = q.max;
                    q.done = true;
                    G.gems += q.rew;
                    fx.float(`+${q.rew} üíé`, "#2ecc71", "hero");
                }
                changed = true;
            }
        });
        if(changed) ui.renderQuests();
    },
    refresh: () => {
        if(G.gems >= 1) {
            G.gems--;
            quests.gen();
        } else alert("Need 1 Gem");
    }
};

// 5. EXTEND UI & CORE
// Initialize Data
if(!G.runes) G.runes = {fire:0, ice:0, storm:0};
if(!G.spells) G.spells = {};
if(!G.quests) quests.gen();

// Hook render
ui.renderMagic = () => {
    // Runes
    document.getElementById('r-fire').innerText = G.runes.fire;
    document.getElementById('r-ice').innerText = G.runes.ice;
    document.getElementById('r-storm').innerText = G.runes.storm;
    
    // Spells
    let el = document.getElementById('spell-list');
    el.innerHTML = "";
    magic.spells.forEach((s, i) => {
        let lvl = G.spells[s.id] || 0;
        let cost = s.cost * (lvl + 1);
        let maxed = lvl >= s.max;
        
        let div = document.createElement('div');
        div.className = `spell-card ${maxed?'maxed':''}`;
        div.onclick = () => magic.craft(i);
        div.innerHTML = `
            <div style="color:${s.type==='fire'?'#e74c3c':(s.type==='ice'?'#74b9ff':'#f1c40f')}">${s.n}</div>
            <div style="font-size:10px; color:#aaa">Lvl ${lvl}/${s.max}</div>
            <div style="font-size:10px; margin-top:5px">${maxed ? 'MAXED' : 'Cost: '+cost}</div>
            <div style="font-size:9px; color:#777; margin-top:5px">${s.desc}</div>
        `;
        el.appendChild(div);
    });
};

ui.renderQuests = () => {
    let el = document.getElementById('quest-list');
    if(!el) return;
    el.innerHTML = "";
    G.quests.forEach(q => {
        let div = document.createElement('div');
        div.className = `quest-row ${q.done?'done':''}`;
        div.innerHTML = `
            <div style="font-size:11px">
                <div>${q.desc}</div>
                <div style="color:#aaa">${q.cur} / ${q.max}</div>
            </div>
            <div style="font-weight:bold; color:#2ecc71">+${q.rew}üíé</div>
        `;
        el.appendChild(div);
    });
};

// Hook Loop
const loopV7 = ui.loop;
ui.loop = () => {
    loopV7();
    // No specific loop updates needed for magic yet, static render is fine
};

// Hook Win (Drop Runes + Quest)
const winV7 = combat.win;
combat.win = () => {
    winV7();
    
    // Drop Runes (30% chance)
    if(Math.random() < 0.3) {
        let r = Math.random();
        let type = r < 0.33 ? 'fire' : (r < 0.66 ? 'ice' : 'storm');
        let amt = 1 + Math.floor(G.stage / 10);
        G.runes[type] += amt;
        fx.float(`+${amt} Rune`, "#fff", "hero");
        ui.renderMagic();
    }
    
    // Quest Progress
    quests.check('kill', 1);
    quests.check('gold', Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1)));
};

// Hook Recalc (Apply Spell Stats)
const recalcV7 = game.recalc;
game.recalc = () => {
    recalcV7(); // Calculate base stats first
    
    // Apply Spell Multipliers
    let dmgMul = 1;
    let hpMul = 1;
    
    magic.spells.forEach(s => {
        let lvl = G.spells[s.id] || 0;
        if(lvl > 0) {
            if(s.stat === 'dmg') dmgMul += (s.val * lvl);
            if(s.stat === 'hp') hpMul += (s.val * lvl);
        }
    });
    
    G.stats.dmg = Math.floor(G.stats.dmg * dmgMul);
    G.stats.hp = Math.floor(G.stats.hp * hpMul);
};

// Hook Click (Quest)
const clickV7 = combat.click || combat.hit; // Support V5/V6 names
combat.click = () => {
    clickV7();
    quests.check('click', 1);
};

// Hook Tab (Render Magic)
const tabV7 = ui.tab;
ui.tab = (id, btn) => {
    tabV7(id, btn);
    if(id === 'magic') {
        ui.renderMagic();
        ui.renderQuests();
    }
};

// Init
ui.renderMagic();
ui.renderQuests();

</script>

</html>
<script>
// 1. INJECT NEW STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* CASINO STYLES */
    .wheel-box { background: #2d3436; padding: 20px; border-radius: 10px; border: 2px solid #e17055; text-align: center; margin: 20px; }
    .wheel-res { font-size: 40px; margin: 10px 0; text-shadow: 0 0 10px #fdcb6e; }
    
    /* DUNGEON STYLES */
    .dungeon-bg { background: repeating-linear-gradient(45deg, #2d3436, #2d3436 10px, #000 10px, #000 20px); }
    .boss-rush-btn { background: #d63031; border: 2px solid #ff7675; box-shadow: 0 0 15px #d63031; animation: pulse 1s infinite; }
    
    /* BLOOD PACT STYLES */
    .pact-box { background: #000; border: 1px solid #d63031; padding: 15px; margin: 10px; color: #ff7675; }
</style>
`);

// 2. INJECT NEW SCREENS (Using insertAdjacentHTML to save existing listeners)
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-casino" class="screen">
        <div style="text-align:center; padding:20px;">
            <h2 style="color:#fdcb6e; margin:0">üé∞ GOBLIN CASINO</h2>
            <p style="color:#aaa; font-size:12px">Win Red Gems or lose it all!</p>
        </div>
        
        <div class="wheel-box">
            <div id="wheel-display" class="wheel-res">üçí üçí üçí</div>
            <div id="casino-msg" style="height:20px; color:#fff; font-size:12px; margin-bottom:10px">Ready to spin?</div>
            <button class="btn" style="width:100%; background:#fdcb6e; color:#000" onclick="casino.spin()">
                SPIN (Cost: <span id="spin-cost">1000</span>g)
            </button>
        </div>

        <div class="pact-box">
            <h3>ü©∏ BLOOD PACT</h3>
            <p style="font-size:11px">Sacrifice 10% Max HP for +20% Perm Damage</p>
            <button class="btn" style="background:#636e72; color:#d63031; border:1px solid #d63031" onclick="casino.pact()">
                ‚úçÔ∏è SIGN PACT
            </button>
            <div style="margin-top:10px; font-size:10px">Pacts Signed: <span id="pact-count">0</span></div>
        </div>
    </div>

    <div id="tab-dungeon" class="screen dungeon-bg">
        <div style="text-align:center; padding:30px;">
            <h1 style="color:#fff; font-size:40px">üíÄ</h1>
            <h2 style="color:#ff7675">BOSS RUSH</h2>
            <p style="color:#bbb; font-size:12px">Defeat 5 Bosses back-to-back.<br>No auto-healing allowed.</p>
            
            <div style="margin: 40px 0;">
                <div style="font-size:14px; margin-bottom:5px">REWARDS:</div>
                <div style="color:#f1c40f">üí∞ 50,000 Gold</div>
                <div style="color:#e84393">üíé 5 Gems</div>
                <div style="color:#74b9ff">‚ú® Massive XP</div>
            </div>

            <button class="btn boss-rush-btn" style="width:100%; height:60px; font-size:16px;" onclick="dungeon.enter()">
                ENTER DUNGEON
            </button>
            <div id="dungeon-status" style="margin-top:20px; color:#e74c3c; font-weight:bold; display:none">WAVE <span id="d-wave">1</span>/5</div>
        </div>
    </div>
`);

// 3. INJECT NAV BUTTONS
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('casino', this)"><i>üé∞</i>LUCK</div>
    <div class="nav-btn" onclick="ui.tab('dungeon', this)"><i>üíÄ</i>DOOM</div>
`);

// 4. DEFINE NEW SYSTEMS
const casino = {
    icons: ["üçí", "üçã", "üîî", "üíé", "üíÄ"],
    cost: 1000,
    spin: () => {
        // Cost scaling
        let cost = 1000 * (G.lvl);
        if(G.gold < cost) return fx.float("Need Gold!", "#aaa", "wheel-display");
        
        G.gold -= cost;
        
        // Spin Animation
        let el = document.getElementById('wheel-display');
        let msg = document.getElementById('casino-msg');
        let spins = 0;
        let interval = setInterval(() => {
            let r1 = casino.icons[Math.floor(Math.random()*casino.icons.length)];
            let r2 = casino.icons[Math.floor(Math.random()*casino.icons.length)];
            let r3 = casino.icons[Math.floor(Math.random()*casino.icons.length)];
            el.innerText = `${r1} ${r2} ${r3}`;
            spins++;
            if(spins > 10) {
                clearInterval(interval);
                casino.result(r1, r2, r3);
            }
        }, 100);
    },
    result: (a, b, c) => {
        let msg = document.getElementById('casino-msg');
        // Logic
        if(a === "üíÄ" && b === "üíÄ" && c === "üíÄ") {
            G.gold = 0;
            msg.innerText = "‚ò†Ô∏è BANKRUPT! ‚ò†Ô∏è";
            msg.style.color = "#d63031";
        } else if (a === "üíé" && b === "üíé" && c === "üíé") {
            G.gems += 50;
            msg.innerText = "JACKPOT! +50 GEMS!";
            msg.style.color = "#e84393";
            fx.float("üíéüíéüíé", "#e84393", "wheel-display");
        } else if (a===b && b===c) {
            let win = G.lvl * 5000;
            G.gold += win;
            msg.innerText = `TRIPLE! +${win}g`;
            msg.style.color = "#f1c40f";
        } else if (a===b || b===c || a===c) {
            let win = G.lvl * 1000;
            G.gold += win;
            msg.innerText = `PAIR! +${win}g`;
            msg.style.color = "#fff";
        } else {
            msg.innerText = "No luck...";
            msg.style.color = "#aaa";
        }
    },
    pact: () => {
        if(!G.pacts) G.pacts = 0;
        if(confirm("Permanently lose 10% Max HP for +20% Damage?")) {
            G.pacts++;
            G.stats.hp = Math.floor(G.stats.hp * 0.9);
            game.recalc(); // Triggers damage boost calculation logic below
            fx.float("PACT SIGNED", "#d63031", "pact-count");
        }
    }
};

const dungeon = {
    active: false,
    wave: 0,
    enter: () => {
        if(dungeon.active) return;
        if(!confirm("Enter Boss Rush? If you die, you earn nothing.")) return;
        
        dungeon.active = true;
        dungeon.wave = 1;
        
        // Switch to battle screen UI but keep dungeon logic
        ui.tab('fight', document.querySelector('.nav-btn')); // Hacky switch
        document.getElementById('boss-ui').style.display = 'block';
        
        dungeon.nextWave();
    },
    nextWave: () => {
        if(dungeon.wave > 5) {
            dungeon.win();
            return;
        }
        
        // Spawn Boss
        S.m_max = (G.stats.dmg * 20) * dungeon.wave; // Dynamic difficulty
        S.m_hp = S.m_max;
        document.getElementById('e-icon').innerText = ["üëø","üëπ","üë∫","üê≤","üíÄ"][dungeon.wave-1];
        document.getElementById('hud-stage').innerText = "RUSH " + dungeon.wave;
        
        fx.float("WAVE "+dungeon.wave, "#e74c3c", "enemy");
        dungeon.wave++;
    },
    win: () => {
        dungeon.active = false;
        G.gold += 50000;
        G.gems += 5;
        G.xp += G.max_xp; // Instant level up
        alert("DUNGEON CLEARED!\n+50k Gold, +5 Gems, +1 Level");
        combat.spawn(); // Return to normal
    }
};

// 5. OVERRIDE & EXTEND CORE FUNCTIONS
// We hook into the existing game loop by overriding the ui.loop function
const oldLoop = ui.loop; // Save old loop
ui.loop = () => {
    oldLoop(); // Run original UI updates
    
    // Update Casino UI
    let cost = 1000 * (G.lvl || 1);
    let sCost = document.getElementById('spin-cost');
    if(sCost) sCost.innerText = cost;
    
    let pCount = document.getElementById('pact-count');
    if(pCount) pCount.innerText = G.pacts || 0;
    
    // Dungeon Logic Injection
    if(dungeon.active) {
        if(S.m_hp <= 0) {
            // Hijack the win condition for dungeon
            dungeon.nextWave();
            // Prevent normal combat.win from firing 5 times by resetting HP slightly
            S.m_hp = 1; 
        }
        if(S.hp <= 0) {
            dungeon.active = false;
            alert("DUNGEON FAILED!");
            combat.spawn();
        }
    }
};

// Hook into damage calculation for Blood Pact
const oldRecalc = game.recalc;
game.recalc = () => {
    oldRecalc();
    if(G.pacts) {
        // Apply 20% dmg boost per pact
        G.stats.dmg = Math.floor(G.stats.dmg * (1 + (G.pacts * 0.2)));
    }
};

// Initialize Pacts on load
if(!G.pacts) G.pacts = 0;

</script>
<script>
// 1. INJECT V8 STYLES (Animations)
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* DYNAMIC BACKGROUNDS */
    .biome-forest { background: linear-gradient(to bottom, #2d3436, #1e272e); } /* Default */
    .biome-swamp  { background: linear-gradient(to bottom, #0a3d62, #079992); }
    .biome-volcano{ background: linear-gradient(to bottom, #4b0000, #800000); }
    .biome-heaven { background: linear-gradient(to bottom, #0984e3, #74b9ff); }

    /* HERO ANIMATIONS */
    .hero-idle { animation: breathe 2s infinite ease-in-out; }
    .hero-run  { animation: runCycle 0.5s infinite linear; }
    .hero-atk  { animation: lungeRight 0.2s forwards; }
    .enemy-atk { animation: lungeLeft 0.2s forwards; }
    
    /* SCROLLING EFFECT */
    .scrolling-bg {
        animation: scrollBg 1s linear infinite;
        background-size: 100% 100%;
    }

    /* KEYFRAMES */
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05) translateY(-2px); } }
    @keyframes lungeRight { 0% { transform: translateX(0); } 50% { transform: translateX(40px) rotate(10deg); } 100% { transform: translateX(0); } }
    @keyframes lungeLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-40px) rotate(-10deg); } 100% { transform: translateX(0); } }
    
    @keyframes runCycle {
        0% { transform: translateY(0) rotate(0deg); }
        25% { transform: translateY(-5px) rotate(5deg); }
        50% { transform: translateY(0) rotate(0deg); }
        75% { transform: translateY(-5px) rotate(-5deg); }
        100% { transform: translateY(0) rotate(0deg); }
    }
    
    /* SKINS MODAL GRID */
    .skin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .skin-opt { font-size: 30px; background: #222; border-radius: 8px; cursor: pointer; padding: 10px; border: 2px solid transparent; }
    .skin-opt.active { border-color: #f1c40f; background: #333; box-shadow: 0 0 10px #f1c40f; }
    .skin-opt.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
    
    /* TRAVEL OVERLAY */
    #travel-msg {
        position: absolute; top: 40%; width: 100%; text-align: center;
        font-weight: 900; font-size: 24px; color: #fff;
        text-shadow: 0 4px 0 #000; display: none;
        animation: zoomIn 0.3s;
    }
    @keyframes zoomIn { from { transform: scale(0); } to { transform: scale(1); } }
</style>
`);

// 2. INJECT SKINS UI into Hero Tab
document.getElementById('tab-hero').insertAdjacentHTML('beforeend', `
    <div style="margin-top:20px; background:#111; padding:15px; border-radius:8px; border:1px solid #333">
        <h3 style="margin:0; color:#e17055">üé≠ WARDROBE</h3>
        <small>Unlock skins by reaching higher stages</small>
        <div class="skin-grid" id="skin-list"></div>
    </div>
`);

// 3. INJECT TRAVEL OVERLAY into Arena
document.getElementById('arena').insertAdjacentHTML('beforeend', `
    <div id="travel-msg">RUNNING...</div>
`);

// 4. LOGIC & SYSTEMS
const world = {
    skins: [
        {id:'base', i:'üßô‚Äç‚ôÇÔ∏è', n:'Wizard', req:1},
        {id:'ninja', i:'ü•∑', n:'Ninja', req:20},
        {id:'robot', i:'ü§ñ', n:'Mecha', req:40},
        {id:'vamp', i:'üßõ', n:'Vampire', req:60},
        {id:'alien', i:'üëΩ', n:'Alien', req:80},
        {id:'god', i:'‚ö°', n:'Zeus', req:100}
    ],
    bg: (stage) => {
        let vp = document.querySelector('.viewport');
        vp.className = 'viewport'; // Reset
        if(stage < 20) vp.classList.add('biome-forest');
        else if(stage < 40) vp.classList.add('biome-swamp');
        else if(stage < 60) vp.classList.add('biome-volcano');
        else vp.classList.add('biome-heaven');
    },
    equipSkin: (idx) => {
        let s = world.skins[idx];
        if(G.stage >= s.req) {
            G.skin = s.i;
            ui.renderSkins();
            world.updateHero();
            fx.float("Equipped!", "#fff", "skin-list");
        } else alert(`Reach Stage ${s.req} to unlock!`);
    },
    updateHero: () => {
        let h = document.querySelector('#hero .f-icon');
        h.innerText = G.skin || 'üßô‚Äç‚ôÇÔ∏è';
        h.classList.add('hero-idle');
    },
    runSequence: (cb) => {
        // HIDE ENEMY
        let e = document.getElementById('enemy');
        e.style.opacity = '0';
        
        // SHOW RUN MSG
        let msg = document.getElementById('travel-msg');
        msg.style.display = 'block';
        
        // ANIMATE HERO
        let h = document.getElementById('hero');
        h.querySelector('.f-icon').classList.remove('hero-idle');
        h.querySelector('.f-icon').classList.add('hero-run');
        
        // ANIMATE BG (Simulate travel)
        let vp = document.querySelector('.viewport');
        // Simple shift effect
        vp.style.backgroundPosition = "100px 0";
        
        setTimeout(() => {
            // STOP RUN
            h.querySelector('.f-icon').classList.remove('hero-run');
            h.querySelector('.f-icon').classList.add('hero-idle');
            vp.style.backgroundPosition = "0 0";
            msg.style.display = 'none';
            e.style.opacity = '1';
            
            cb(); // Call Spawn
        }, 1000); // 1 second run time
    }
};

// 5. HOOKS (Intercepting previous logic)

// Initialize Skin
if(!G.skin) G.skin = 'üßô‚Äç‚ôÇÔ∏è';
world.updateHero();

// Hook UI Render for Skins
ui.renderSkins = () => {
    let el = document.getElementById('skin-list');
    el.innerHTML = "";
    world.skins.forEach((s, i) => {
        let locked = G.stage < s.req;
        let active = G.skin === s.i;
        el.innerHTML += `
            <div class="skin-opt ${active?'active':''} ${locked?'locked':''}" onclick="world.equipSkin(${i})">
                ${s.i}
                <div style="font-size:8px; color:#aaa">${locked ? 'Lv'+s.req : s.n}</div>
            </div>
        `;
    });
};
// Add to loop
const loopV8 = ui.loop;
ui.loop = () => {
    loopV8();
    if(G.ticks % 50 === 0) world.bg(G.stage); // Check biome every few seconds
};

// Hook Combat Win to trigger Run Sequence
const winV8 = combat.win;
combat.win = () => {
    winV8(); // Give rewards
    
    // Stop auto-spawn from V6/V7 (We need to handle it manually for animation)
    // We clear the timeout set by previous versions
    let id = setTimeout(function() {}, 0);
    while (id--) {
        clearTimeout(id); // Brutal clear of all timeouts to stop instant spawn
    }
    
    // Resume game loop interval though
    
    world.runSequence(() => {
        combat.spawn();
        // If in dungeon, logic handles itself, but for normal play:
        if(!dungeon.active) {
            // standard spawn happened
        }
    });
};

// Hook Combat Hit for Animations
const hitV8 = combat.deal;
combat.deal = (amt, col) => {
    hitV8(amt, col);
    
    // Animate Hero Lunge
    let h = document.querySelector('#hero .f-icon');
    h.classList.remove('hero-atk');
    void h.offsetWidth; // Trigger reflow
    h.classList.add('hero-atk');
};

// Hook Enemy Hit for Animations
const enemyHitV8 = combat.enemyHit;
combat.enemyHit = () => {
    enemyHitV8();
    // Animate Enemy Lunge
    let e = document.querySelector('#enemy .f-icon');
    e.classList.remove('enemy-atk');
    void e.offsetWidth;
    e.classList.add('enemy-atk');
};

// Initial Render
ui.renderSkins();
world.bg(G.stage);

</script>
<script>
// 1. INJECT NEW ANIMATION STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* COMBAT MOVEMENT */
    .move-dash { animation: dashAttack 0.2s forwards; }
    .move-recoil { animation: takeHit 0.3s forwards; }
    .move-victory { animation: victoryHop 0.5s infinite ease-in-out; }
    
    /* PARTICLE FX (Blood/Sparks) */
    .spark {
        position: absolute; width: 6px; height: 6px; border-radius: 50%;
        pointer-events: none; z-index: 50;
    }

    @keyframes dashAttack {
        0% { transform: translateX(0) scale(1); }
        50% { transform: translateX(80px) scale(1.2); } /* Move closer to enemy */
        100% { transform: translateX(0) scale(1); }
    }

    @keyframes takeHit {
        0% { transform: translateX(0) rotate(0deg); filter: none; }
        25% { transform: translateX(-20px) rotate(-10deg); filter: brightness(3) sepia(1) saturate(5) hue-rotate(-50deg); } /* Flash Red */
        100% { transform: translateX(0) rotate(0deg); filter: none; }
    }

    @keyframes victoryHop {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-40px) scaleY(1.1); }
    }
    
    /* SCREEN SHAKE ON CRIT */
    .screen-shake { animation: shakeScreen 0.2s; }
    @keyframes shakeScreen {
        0% { transform: translate(0,0); }
        25% { transform: translate(5px, 5px); }
        50% { transform: translate(-5px, -5px); }
        75% { transform: translate(5px, -5px); }
        100% { transform: translate(0,0); }
    }
</style>
`);

// 2. ENHANCE COMBAT LOGIC
// We hook into the existing combat functions to add the new movement classes

const hitV9 = combat.deal; // Save the previous version's hit function
combat.deal = (amt, col) => {
    hitV9(amt, col); // Run the old logic first (damage, logs, etc)
    
    // 1. HERO DASH ANIMATION
    let h = document.querySelector('#hero .f-icon');
    h.classList.remove('move-dash');
    void h.offsetWidth; // Force reset
    h.classList.add('move-dash');
    
    // 2. ENEMY RECOIL ANIMATION
    let e = document.querySelector('#enemy .f-icon');
    e.classList.remove('move-recoil');
    void e.offsetWidth;
    e.classList.add('move-recoil');
    
    // 3. SPAWN PARTICLES
    spawnParticles(col);
    
    // 4. SCREEN SHAKE (If critical hit/color is not white)
    if(col !== '#fff') {
        document.body.classList.remove('screen-shake');
        void document.body.offsetWidth;
        document.body.classList.add('screen-shake');
    }
};

// Hook Enemy Attacks (Hero gets hit)
const enemyHitV9 = combat.enemyHit;
combat.enemyHit = () => {
    enemyHitV9();
    
    // HERO RECOIL
    let h = document.querySelector('#hero .f-icon');
    h.classList.remove('move-recoil');
    void h.offsetWidth;
    h.classList.add('move-recoil');
};

// Hook Victory (Celebrate!)
const winV9 = combat.win;
combat.win = () => {
    // HERO JUMPS
    let h = document.querySelector('#hero .f-icon');
    h.classList.add('move-victory');
    
    // Delay the actual win reset slightly so we can see the jump
    setTimeout(() => {
        h.classList.remove('move-victory');
        winV9();
    }, 1200); // 1.2 second celebration
};

// 3. PARTICLE SYSTEM FUNCTION
function spawnParticles(color) {
    let parent = document.querySelector('.arena');
    // Create 5 particles
    for(let i=0; i<5; i++) {
        let p = document.createElement('div');
        p.className = 'spark';
        p.style.backgroundColor = color;
        
        // Position at enemy center roughly
        let e = document.getElementById('enemy');
        p.style.left = (e.offsetLeft + 40) + "px";
        p.style.top = (e.offsetTop + 40) + "px";
        
        parent.appendChild(p);
        
        // Animate using JS for physics
        let angle = Math.random() * Math.PI * 2;
        let speed = Math.random() * 10 + 5;
        let velX = Math.cos(angle) * speed;
        let velY = Math.sin(angle) * speed;
        let life = 1.0;
        
        let timer = setInterval(() => {
            let rect = p.getBoundingClientRect();
            p.style.left = (parseFloat(p.style.left) + velX) + "px";
            p.style.top = (parseFloat(p.style.top) + velY) + "px";
            
            velY += 1; // Gravity
            life -= 0.05;
            p.style.opacity = life;
            p.style.transform = `scale(${life})`;
            
            if(life <= 0) {
                clearInterval(timer);
                p.remove();
            }
        }, 30);
    }
}
</script>
<script>
// 1. INJECT V10 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* EXPLOSIVE TEXT */
    .pop-text {
        position: absolute; font-weight: 900; font-size: 22px; 
        pointer-events: none; z-index: 100;
        text-shadow: 2px 2px 0 #000;
        will-change: transform, opacity;
    }
    
    /* LOW HEALTH VIGNETTE */
    .vignette {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        box-shadow: inset 0 0 100px rgba(255, 0, 0, 0);
        pointer-events: none; z-index: 90;
        transition: box-shadow 0.2s;
    }
    .vignette.critical {
        box-shadow: inset 0 0 150px rgba(231, 76, 60, 0.8);
        animation: pulseRed 1s infinite;
    }
    
    @keyframes pulseRed {
        0%, 100% { box-shadow: inset 0 0 100px rgba(231, 76, 60, 0.5); }
        50% { box-shadow: inset 0 0 200px rgba(231, 76, 60, 0.9); }
    }
</style>
`);

// 2. INJECT VIGNETTE OVERLAY
document.body.insertAdjacentHTML('afterbegin', `<div id="screen-vignette" class="vignette"></div>`);

// 3. SOUND ENGINE (Synthesizer)
const audio = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: (type) => {
        if(audio.ctx.state === 'suspended') audio.ctx.resume();
        
        let osc = audio.ctx.createOscillator();
        let gain = audio.ctx.createGain();
        osc.connect(gain);
        gain.connect(audio.ctx.destination);
        
        let now = audio.ctx.currentTime;
        
        if (type === 'hit') {
            // Punchy noise
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } 
        else if (type === 'coin') {
            // High ping
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.linearRampToValueAtTime(1800, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
        else if (type === 'level') {
            // Power up slide
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(600, now + 0.5);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        }
    }
};

// 4. PHYSICS TEXT ENGINE (Overrides old fx.float)
// This makes numbers pop out and fall with gravity!
fx.float = (txt, col, parentId) => {
    let p = document.getElementById(parentId);
    let el = document.createElement('div');
    el.className = 'pop-text';
    el.innerText = txt; 
    el.style.color = col;
    
    // Start position
    let startX = (p.offsetLeft + 40);
    let startY = (p.offsetTop + 20);
    el.style.left = startX + "px";
    el.style.top = startY + "px";
    
    document.body.appendChild(el);
    
    // Physics Variables
    let vx = (Math.random() - 0.5) * 10; // Random horizontal spread
    let vy = -10 - (Math.random() * 5);  // Initial jump up force
    let gravity = 0.8;                   // Gravity pulls down
    let opacity = 1;
    
    let physInt = setInterval(() => {
        // Apply physics
        vy += gravity;
        startX += vx;
        startY += vy;
        
        // Apply to CSS
        el.style.left = startX + "px";
        el.style.top = startY + "px";
        
        // Fade out
        if(vy > 0) opacity -= 0.03; // Only fade once falling
        el.style.opacity = opacity;
        el.style.transform = `scale(${opacity})`; // Shrink as it fades
        
        if(opacity <= 0 || startY > window.innerHeight) {
            clearInterval(physInt);
            el.remove();
        }
    }, 20); // 50fps
};

// 5. HOOKS TO TRIGGER SOUNDS & VISUALS

// Hook Combat Deal (Hit Sound)
const hitV10 = combat.deal;
combat.deal = (amt, col) => {
    hitV10(amt, col);
    audio.play('hit');
    
    // Check for Low Health Visuals
    let hpPct = S.hp / G.stats.hp;
    let vig = document.getElementById('screen-vignette');
    if(hpPct < 0.3) vig.classList.add('critical');
    else vig.classList.remove('critical');
};

// Hook Win (Coin Sound)
const winV10 = combat.win;
combat.win = () => {
    winV10();
    setTimeout(() => audio.play('coin'), 200); // Slight delay for satisfaction
};

// Hook Level Up (Level Sound)
// We need to hijack the check inside combat.win/winV10, but since we can't easily reach inside function scopes,
// we will add a listener to the XP bar or check level change.
// Simple method: Check if level changed in the UI loop.
let lastLvlV10 = G.lvl;
const loopV10 = ui.loop;
ui.loop = () => {
    loopV10();
    
    // Level Up Sound Check
    if(G.lvl > lastLvlV10) {
        lastLvlV10 = G.lvl;
        audio.play('level');
    }
    
    // HP Vignette Safety Check (in case healed by potion)
    let hpPct = S.hp / G.stats.hp;
    let vig = document.getElementById('screen-vignette');
    if(hpPct >= 0.3) vig.classList.remove('critical');
};

</script>
<script>
// 1. INJECT V11 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* WEATHER OVERLAYS */
    .env-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 5; transition: background 2s; }
    .env-night { background: rgba(0, 0, 50, 0.4); mix-blend-mode: multiply; }
    .env-rain { background: rgba(0, 0, 0, 0.2); }
    
    /* RAIN PARTICLES */
    .rain-drop {
        position: fixed; width: 2px; height: 10px; background: #74b9ff;
        animation: fall 0.5s linear infinite; opacity: 0.6; z-index: 6;
    }
    @keyframes fall { to { transform: translateY(100vh); } }

    /* FARMING GRID */
    .farm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
    .plot {
        background: #3e2723; border: 2px solid #5d4037; border-radius: 8px;
        height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; position: relative; overflow: hidden;
    }
    .plot:active { transform: scale(0.95); }
    .crop-icon { font-size: 30px; transition: transform 0.5s; }
    .plot-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: #2ecc71; width: 0%; transition: width 1s linear; }

    /* FISHING UI */
    .water-box {
        background: linear-gradient(to bottom, #2980b9, #2c3e50);
        height: 120px; border-radius: 10px; position: relative; margin-top: 15px;
        border-top: 4px solid #3498db; overflow: hidden; cursor: pointer;
    }
    .bobber {
        font-size: 24px; position: absolute; left: 50%; top: 40%;
        transform: translate(-50%, -50%); transition: top 0.2s;
        animation: bob 1s infinite ease-in-out;
    }
    .bobber.sink { top: 70%; animation: none; }
    .splash { position: absolute; left: 50%; top: 60%; font-size: 20px; transform: translate(-50%, -50%); opacity: 0; }
    @keyframes bob { 0%,100% { top: 40%; } 50% { top: 45%; } }

    /* CLOCK UI */
    .clock-widget {
        position: absolute; top: 10px; right: 10px;
        background: rgba(0,0,0,0.8); padding: 5px 10px;
        border-radius: 20px; font-size: 11px; border: 1px solid #555;
        z-index: 20; display: flex; align-items: center; gap: 5px;
    }
</style>
`);

// 2. INJECT ENVIRONMENT OVERLAY & VILLAGE TAB
document.body.insertAdjacentHTML('afterbegin', `<div id="env-layer" class="env-overlay"></div>`);

document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-village" class="screen" style="padding:15px">
        <div class="clock-widget">
            <span id="world-icon">‚òÄÔ∏è</span> <span id="world-time">Day</span>
        </div>

        <div style="text-align:center; margin-bottom:15px">
            <h2 style="color:#2ecc71; margin:0">PEACEFUL VILLAGE</h2>
            <small>Farm & Fish to relax</small>
        </div>

        <div style="background:#222; padding:10px; border-radius:8px; border:1px solid #444;">
            <h3 style="margin:0; color:#3498db">üé£ FISHERMAN'S DOCK</h3>
            <div style="font-size:10px; color:#aaa">Click water to Cast. Click when it sinks!</div>
            
            <div class="water-box" onclick="fishing.click()" id="fish-water">
                <div class="bobber" id="bobber">üî¥</div>
                <div class="splash" id="splash">üí¶</div>
                <div id="fish-msg" style="position:absolute; width:100%; text-align:center; top:10px; color:#fff; font-weight:bold; text-shadow:0 1px 2px #000">TAP TO CAST</div>
            </div>
        </div>

        <div style="margin-top:20px; background:#222; padding:10px; border-radius:8px; border:1px solid #444;">
            <h3 style="margin:0; color:#e67e22">üå± SPIRIT GARDEN</h3>
            <div style="font-size:10px; color:#aaa">Seeds drop from enemies. Eat fruit for PERMANENT stats.</div>
            
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:11px; background:#111; padding:5px; border-radius:4px;">
                <span>üéí Seeds: <span id="seed-cnt">0</span></span>
            </div>

            <div class="farm-grid" id="farm-plots">
                </div>
        </div>
    </div>
`);

// 3. INJECT NAV
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('village', this)"><i>üè°</i>HOME</div>
`);

// 4. LOGIC SYSTEMS
const village = {
    time: 0, // 0-100 cycle
    state: 'day', // day, night, rain
    plots: [
        {active:false, timer:0, max:100, type:'apple'},
        {active:false, timer:0, max:100, type:'apple'},
        {active:false, timer:0, max:100, type:'apple'}
    ],
    
    // Environment Logic
    tickEnv: () => {
        village.time++;
        if(village.time > 100) {
            village.time = 0;
            // Random weather change
            let r = Math.random();
            if(r < 0.3) village.setWeather('rain');
            else if(r < 0.6) village.setWeather('night');
            else village.setWeather('day');
        }
        
        // Render Time
        let ico = village.state === 'rain' ? 'üåßÔ∏è' : (village.state==='night'?'üåô':'‚òÄÔ∏è');
        document.getElementById('world-icon').innerText = ico;
        document.getElementById('world-time').innerText = village.state.toUpperCase();
    },
    
    setWeather: (w) => {
        village.state = w;
        let el = document.getElementById('env-layer');
        el.className = 'env-overlay'; // Reset
        
        // Remove old rain
        document.querySelectorAll('.rain-drop').forEach(e => e.remove());
        
        if(w === 'night') {
            el.classList.add('env-night');
            fx.float("NIGHTFALL (XP x2)", "#a29bfe", "hero");
        }
        if(w === 'rain') {
            el.classList.add('env-rain');
            village.makeRain();
            fx.float("RAIN (Growth x2)", "#3498db", "hero");
        }
        if(w === 'day') {
            fx.float("SUNRISE", "#f1c40f", "hero");
        }
    },
    
    makeRain: () => {
        if(village.state !== 'rain') return;
        for(let i=0; i<10; i++) {
            let d = document.createElement('div');
            d.className = 'rain-drop';
            d.style.left = Math.random() * 100 + "vw";
            d.style.animationDuration = (0.5 + Math.random()*0.5) + "s";
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }
        setTimeout(village.makeRain, 200);
    }
};

const farming = {
    plant: (idx) => {
        if(G.seeds > 0 && !village.plots[idx].active) {
            G.seeds--;
            village.plots[idx].active = true;
            village.plots[idx].timer = 0;
            ui.renderFarm();
        } else if (village.plots[idx].active && village.plots[idx].timer >= 100) {
            // Harvest
            village.plots[idx].active = false;
            let fruit = village.plots[idx].type;
            
            // Perma Stat Buff
            G.upg.hp += 1; // +20 HP per fruit (based on existing math)
            G.stats.hp += 20; 
            S.hp += 20;
            
            fx.float("YUMMY! Max HP UP!", "#2ecc71", "farm-plots");
            audio.play('coin'); // Re-use coin sound
            ui.renderFarm();
        }
    },
    tick: () => {
        village.plots.forEach(p => {
            if(p.active && p.timer < 100) {
                // Rain doubles growth speed
                let speed = village.state === 'rain' ? 2 : 0.5;
                p.timer += speed;
                if(p.timer > 100) p.timer = 100;
            }
        });
        if(document.getElementById('tab-village').style.display === 'flex') ui.renderFarm();
    }
};

const fishing = {
    state: 'idle', // idle, waiting, biting
    tmr: null,
    click: () => {
        let b = document.getElementById('bobber');
        let msg = document.getElementById('fish-msg');
        
        if(fishing.state === 'idle') {
            // CAST
            fishing.state = 'waiting';
            msg.innerText = "WAITING...";
            b.style.top = "40%";
            b.classList.remove('sink');
            
            let waitTime = 2000 + Math.random() * 3000;
            fishing.tmr = setTimeout(fishing.bite, waitTime);
        } 
        else if (fishing.state === 'waiting') {
            // PULLED TOO EARLY
            clearTimeout(fishing.tmr);
            fishing.reset("TOO EARLY!");
        }
        else if (fishing.state === 'biting') {
            // CATCH!
            clearTimeout(fishing.tmr);
            
            let r = Math.random();
            let reward = "";
            if(r < 0.1) { G.gems += 2; reward = "2 GEMS!"; }
            else { 
                let g = G.lvl * 50; 
                G.gold += g; 
                reward = g + " GOLD!"; 
            }
            
            fx.float("üé£ CAUGHT " + reward, "#f1c40f", "fish-water");
            audio.play('level'); // Re-use level sound
            fishing.reset("NICE CATCH!");
        }
    },
    bite: () => {
        fishing.state = 'biting';
        let b = document.getElementById('bobber');
        b.classList.add('sink');
        document.getElementById('fish-msg').innerText = "CLICK NOW!!!";
        document.getElementById('fish-msg').style.color = "#e74c3c";
        
        // Fail if too slow (1 sec window)
        fishing.tmr = setTimeout(() => {
            fishing.reset("GOT AWAY...");
        }, 800);
    },
    reset: (txt) => {
        fishing.state = 'idle';
        document.getElementById('fish-msg').innerText = txt;
        document.getElementById('fish-msg').style.color = "#fff";
        document.getElementById('bobber').classList.remove('sink');
        setTimeout(() => {
            if(fishing.state === 'idle') document.getElementById('fish-msg').innerText = "TAP TO CAST";
        }, 1500);
    }
};

// 5. EXTEND UI & CORE HOOKS

// Init Data
if(!G.seeds) G.seeds = 0;

ui.renderFarm = () => {
    let el = document.getElementById('farm-plots');
    el.innerHTML = "";
    document.getElementById('seed-cnt').innerText = G.seeds;
    
    village.plots.forEach((p, i) => {
        let ready = p.timer >= 100;
        let icon = !p.active ? "üï≥Ô∏è" : (ready ? "üçé" : "üå±");
        let d = document.createElement('div');
        d.className = 'plot';
        d.onclick = () => farming.plant(i);
        d.innerHTML = `
            <div class="crop-icon" style="transform:scale(${p.active ? 1 + (p.timer/100) : 1})">${icon}</div>
            <div class="plot-bar" style="width:${p.timer}%"></div>
            ${ready ? '<div style="position:absolute; top:0; width:100%; text-align:center; font-size:9px; background:rgba(0,0,0,0.5)">HARVEST</div>' : ''}
        `;
        el.appendChild(d);
    });
};

// Hook Loop (Weather & Farming)
const loopV11 = ui.loop;
ui.loop = () => {
    loopV11();
    if(G.ticks % 10 === 0) village.tickEnv(); // Weather tick
    farming.tick(); // Farm growth tick
};

// Hook Win (Drop Seeds & Night XP)
const winV11 = combat.win;
combat.win = () => {
    // Night XP Bonus
    if(village.state === 'night') {
        G.xp += (20 + G.stage * 5); // Double XP basically
        fx.float("NIGHT XP!", "#a29bfe", "hero");
    }
    
    winV11();
    
    // Seed Drop (20% chance)
    if(Math.random() < 0.2) {
        G.seeds++;
        fx.float("üå± SEED", "#2ecc71", "hero");
    }
};

// Init UI
ui.renderFarm();

</script>
<script>
// 1. INJECT V12 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* CHAT WIDGET */
    .chat-box {
        position: fixed; bottom: 80px; left: 10px; width: 200px; height: 120px;
        background: rgba(0,0,0,0.6); border-radius: 8px; pointer-events: none;
        overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end;
        padding: 5px; font-size: 10px; z-index: 20; border: 1px solid #444;
    }
    .chat-msg { margin-bottom: 2px; text-shadow: 1px 1px 0 #000; animation: fadeUp 0.3s; }
    .chat-name { font-weight: bold; color: #f1c40f; }
    .chat-sys { color: #2ecc71; font-style: italic; }

    /* RAID BOSS BAR */
    .raid-overlay {
        position: absolute; top: 50px; left: 10%; width: 80%; 
        background: #222; border: 2px solid #e74c3c; border-radius: 4px;
        padding: 5px; text-align: center; display: none; z-index: 15;
        box-shadow: 0 0 20px #e74c3c;
    }
    .raid-hp-bar { height: 8px; background: #c0392b; width: 100%; transition: width 0.2s; }

    /* GUILD UI */
    .perk-card {
        background: #1e272e; padding: 10px; margin-bottom: 8px; border-radius: 6px;
        display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #3498db;
    }
    .donate-btn { background: #f1c40f; color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
</style>
`);

// 2. INJECT CHAT & RAID UI
document.body.insertAdjacentHTML('beforeend', `
    <div id="world-chat" class="chat-box">
        <div class="chat-msg"><span class="chat-sys">System: Welcome to RPG V12!</span></div>
    </div>
`);

document.getElementById('arena').insertAdjacentHTML('beforeend', `
    <div id="raid-ui" class="raid-overlay">
        <div style="font-weight:bold; color:#e74c3c; font-size:12px; margin-bottom:2px">‚ö†Ô∏è WORLD RAID: TITAN</div>
        <div style="background:#000; height:8px; width:100%"><div id="raid-bar" class="raid-hp-bar"></div></div>
        <div style="font-size:9px; color:#fff; margin-top:2px"><span id="raid-hp">0</span> HP</div>
    </div>
`);

// 3. INJECT GUILD TAB
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-guild" class="screen" style="padding:15px">
        <div style="text-align:center; margin-bottom:15px; background:#111; padding:15px; border-radius:8px">
            <h2 style="color:#f1c40f; margin:0">üëë THE GUILD</h2>
            <div style="color:#aaa; font-size:11px">Level <span id="g-lvl">1</span> ‚Ä¢ Members: 42</div>
            <div style="margin-top:10px; font-size:20px">Treasury: <span id="g-fund">0</span> / <span id="g-req">1000</span></div>
            <button class="btn" style="width:100%; margin-top:10px; background:#f1c40f; color:#000" onclick="guild.donate()">
                DONATE 500g
            </button>
        </div>

        <h3 style="color:#3498db">GUILD PERKS</h3>
        <div id="guild-perks"></div>
    </div>
`);

document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('guild', this)"><i>üõ°Ô∏è</i>GUILD</div>
`);

// 4. LOGIC SYSTEMS
const guild = {
    perks: [
        {n:"Gold Boost", desc:"+10% Gold Drop", req:1},
        {n:"XP Boost", desc:"+10% XP Gain", req:2},
        {n:"Raid Power", desc:"Guildmates help in Raids", req:3},
        {n:"Gem Luck", desc:"Double Gem Chance", req:5}
    ],
    donate: () => {
        if(G.gold >= 500) {
            G.gold -= 500;
            G.guild_xp += 500;
            chat.add("You", "Donated 500g to Guild!");
            guild.checkLvl();
            ui.renderGuild();
        } else alert("Need 500g");
    },
    checkLvl: () => {
        let req = G.guild_lvl * 1000;
        if(G.guild_xp >= req) {
            G.guild_xp -= req;
            G.guild_lvl++;
            chat.sys(`GUILD LEVELED UP TO ${G.guild_lvl}!`);
            audio.play('level');
        }
    }
};

const raid = {
    active: false,
    hp: 0, max: 0,
    timer: null,
    start: () => {
        if(raid.active) return;
        raid.active = true;
        raid.max = G.stats.dmg * 500; // Massive HP
        raid.hp = raid.max;
        
        document.getElementById('raid-ui').style.display = 'block';
        chat.sys("‚ö†Ô∏è RAID BOSS SPAWNED!");
        
        // Guildmates auto-attack
        raid.timer = setInterval(() => {
            if(!raid.active) return;
            // Guildmates do damage based on guild level
            let teamDmg = Math.floor(G.stats.dmg * (G.guild_lvl * 0.5));
            raid.hit(teamDmg, true);
        }, 1000);
    },
    hit: (dmg, isAuto) => {
        if(!raid.active) return;
        raid.hp -= dmg;
        if(raid.hp <= 0) raid.win();
        
        // Update UI
        let pct = (raid.hp / raid.max) * 100;
        document.getElementById('raid-bar').style.width = pct + "%";
        document.getElementById('raid-hp').innerText = Math.floor(raid.hp);
        
        if(!isAuto) fx.float(dmg, "#e74c3c", "raid-ui");
    },
    win: () => {
        raid.active = false;
        clearInterval(raid.timer);
        document.getElementById('raid-ui').style.display = 'none';
        
        let rw_gems = 2 + G.guild_lvl;
        let rw_gold = 10000 * G.guild_lvl;
        G.gems += rw_gems;
        G.gold += rw_gold;
        
        chat.sys(`RAID DEFEATED! +${rw_gems} Gems`);
        fx.float("VICTORY!", "#f1c40f", "hero");
        audio.play('level');
    }
};

const chat = {
    names: ["Slayer99", "NoobMaster", "Gandalf", "HealerGril", "TankBoi", "GemFarmer"],
    msgs: ["LFG Raid", "Anyone want to trade?", "Just got a Legendary!", "Donate to guild pls", "This boss is hard", "Gz on level up!"],
    
    add: (name, txt) => {
        let box = document.getElementById('world-chat');
        let el = document.createElement('div');
        el.className = 'chat-msg';
        el.innerHTML = `<span class="chat-name">${name}:</span> ${txt}`;
        box.appendChild(el);
        if(box.children.length > 5) box.firstChild.remove();
    },
    sys: (txt) => {
        let box = document.getElementById('world-chat');
        let el = document.createElement('div');
        el.className = 'chat-msg';
        el.innerHTML = `<span class="chat-sys">[SYSTEM] ${txt}</span>`;
        box.appendChild(el);
        if(box.children.length > 5) box.firstChild.remove();
    },
    loop: () => {
        // Randomly generate chat
        if(Math.random() < 0.01) {
            let n = chat.names[Math.floor(Math.random()*chat.names.length)];
            let m = chat.msgs[Math.floor(Math.random()*chat.msgs.length)];
            chat.add(n, m);
        }
        // Random Raid Spawn (1% chance per tick if not active)
        if(!raid.active && Math.random() < 0.002) raid.start();
    }
};

// 5. EXTEND CORE

// Init Data
if(!G.guild_lvl) { G.guild_lvl = 1; G.guild_xp = 0; }

ui.renderGuild = () => {
    document.getElementById('g-lvl').innerText = G.guild_lvl;
    document.getElementById('g-fund').innerText = G.guild_xp;
    document.getElementById('g-req').innerText = G.guild_lvl * 1000;
    
    let el = document.getElementById('guild-perks');
    el.innerHTML = "";
    guild.perks.forEach(p => {
        let active = G.guild_lvl >= p.req;
        el.innerHTML += `
            <div class="perk-card" style="opacity:${active?1:0.5}; border-color:${active?'#2ecc71':'#555'}">
                <div>
                    <div style="font-weight:bold; color:#fff">${p.n}</div>
                    <div style="font-size:10px; color:#aaa">${p.desc}</div>
                </div>
                <div style="font-size:10px">${active ? '‚úÖ ACTIVE' : 'Lvl '+p.req}</div>
            </div>
        `;
    });
};

// Hook Loop
const loopV12 = ui.loop;
ui.loop = () => {
    loopV12();
    chat.loop();
};

// Hook Combat Deal (Raid Damage)
const hitV12 = combat.deal;
combat.deal = (amt, col) => {
    hitV12(amt, col);
    if(raid.active) raid.hit(amt, false); // Deal damage to raid boss too
};

// Hook Win (Gold Bonus)
const winV12 = combat.win;
combat.win = () => {
    // Guild Gold Bonus
    if(G.guild_lvl >= 1) {
        G.gold += Math.floor((10 + G.stage) * 0.1); 
    }
    winV12();
};

// Hook Tab
const tabV12 = ui.tab;
ui.tab = (id, btn) => {
    tabV12(id, btn);
    if(id === 'guild') ui.renderGuild();
};

</script>
<script>
// 1. INJECT V13 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* CHAT TRANSPARENCY FIX */
    .chat-box {
        opacity: 0.4; transition: opacity 0.3s;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .chat-box:hover { opacity: 1; background: rgba(0,0,0,0.8); }

    /* DUNGEON GATE ANIMATION */
    .gate-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 50; pointer-events: none; display: flex;
        justify-content: center; align-items: center;
    }
    .gate-left, .gate-right {
        width: 50%; height: 100%; background: #111;
        position: absolute; top: 0; transition: transform 1s ease-in-out;
        border-right: 2px solid #333;
        background-image: repeating-linear-gradient(45deg, #111 0px, #111 20px, #222 20px, #222 40px);
    }
    .gate-left { left: 0; transform: translateX(-100%); border-right: 5px solid #000; }
    .gate-right { right: 0; transform: translateX(100%); border-left: 5px solid #000; }
    
    .gate-active .gate-left { transform: translateX(0); }
    .gate-active .gate-right { transform: translateX(0); }
    
    .gate-text {
        position: absolute; z-index: 52; color: #fff; font-size: 40px; 
        font-weight: 900; opacity: 0; transition: opacity 0.5s;
        text-shadow: 0 0 20px #e74c3c; letter-spacing: 5px;
    }

    /* VOID SHOP STYLES */
    .void-card {
        background: #000; border: 1px solid #9b59b6; padding: 15px;
        margin-bottom: 10px; border-radius: 6px; box-shadow: 0 0 10px #8e44ad;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* WALKING OVERRIDE */
    .hero-walk-in { animation: walkIn 1.5s forwards linear; }
    @keyframes walkIn {
        0% { transform: translateX(-100px) scale(0.8); opacity: 0; }
        100% { transform: translateX(0) scale(1); opacity: 1; }
    }
</style>
`);

// 2. INJECT GATE HTML
document.body.insertAdjacentHTML('beforeend', `
    <div id="dungeon-gate" class="gate-overlay">
        <div class="gate-left"></div>
        <div class="gate-right"></div>
        <div id="gate-msg" class="gate-text">ENTERING VOID...</div>
    </div>
`);

// 3. INJECT VOID TAB
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-void" class="screen" style="padding:20px; background: radial-gradient(circle, #2c3e50, #000);">
        <div style="text-align:center; margin-bottom:20px">
            <h1 style="color:#9b59b6; margin:0; font-size:40px">üåÄ</h1>
            <h2 style="color:#fff; text-shadow:0 0 10px #9b59b6">THE VOID</h2>
            <p style="color:#aaa; font-size:12px">Reset World to gain Power</p>
        </div>

        <div style="background:#111; padding:15px; border-radius:10px; text-align:center; border:1px solid #9b59b6">
            <div style="font-size:24px; color:#e056fd">Void Shards: <span id="void-curr">0</span></div>
            <div style="margin:10px 0; font-size:11px; color:#aaa">Requires Stage 100 to Ascend</div>
            <button class="btn" style="width:100%; background:#8e44ad" onclick="voidSys.ascend()">
                ASCEND NOW (+<span id="void-gain">0</span> Shards)
            </button>
        </div>

        <h3 style="color:#fff; margin-top:20px">VOID UPGRADES</h3>
        <div id="void-shop"></div>
    </div>
`);

// 4. INJECT NAV BUTTON
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('void', this)"><i>üåÄ</i>VOID</div>
`);

// 5. NEW SYSTEMS

const visual = {
    enterDungeon: (name, callback) => {
        let g = document.getElementById('dungeon-gate');
        let txt = document.getElementById('gate-msg');
        
        // 1. Close Gate
        g.classList.add('gate-active');
        audio.play('hit'); // Slam sound
        
        setTimeout(() => {
            // 2. Show Text
            txt.innerText = name;
            txt.style.opacity = 1;
            
            setTimeout(() => {
                // 3. Run Logic (while hidden)
                if(callback) callback();
                
                // 4. Open Gate
                txt.style.opacity = 0;
                g.classList.remove('gate-active');
                
                // 5. Hero Walks In
                let h = document.querySelector('#hero .f-icon');
                h.classList.add('hero-walk-in');
                setTimeout(() => h.classList.remove('hero-walk-in'), 1500);
                
            }, 1000);
        }, 1000);
    }
};

const voidSys = {
    upgrades: [
        {id:'v_spd', n:'Time Warp', desc:'Game Speed +10%', cost:1, max:5},
        {id:'v_str', n:'Void Strength', desc:'Damage x2', cost:5, max:100},
        {id:'v_start', n:'Head Start', desc:'Start at Stage +10', cost:2, max:10}
    ],
    calcGain: () => {
        if(G.stage < 100) return 0;
        return Math.floor((G.stage - 90) / 10);
    },
    ascend: () => {
        let gain = voidSys.calcGain();
        if(gain <= 0) return alert("Reach Stage 100 first!");
        
        if(confirm(`Reset world for ${gain} Void Shards?`)) {
            // Give Currency
            if(!G.void_shards) G.void_shards = 0;
            G.void_shards += gain;
            
            // RESET PROGRESS (Keep Gems, Pets, Guild, Void)
            G.lvl = 1; G.gold = 0; G.stage = 1 + (G.void_upg ? (G.void_upg.v_start||0)*10 : 0);
            G.xp = 0; G.stats.dmg = 10; G.stats.hp = 100;
            G.inv = []; G.eq = {w:null, a:null};
            
            // Visuals
            visual.enterDungeon("ASCENDING...", () => {
                game.save();
                location.reload();
            });
        }
    },
    buy: (idx) => {
        let u = voidSys.upgrades[idx];
        if(!G.void_upg) G.void_upg = {};
        let lvl = G.void_upg[u.id] || 0;
        
        if(lvl >= u.max) return;
        if(G.void_shards >= u.cost) {
            G.void_shards -= u.cost;
            G.void_upg[u.id] = lvl + 1;
            ui.renderVoid();
            game.recalc(); // Apply stats
        }
    }
};

// 6. OVERRIDES & HOOKS

// Hook Recalc (Apply Void Multipliers)
const recalcV13 = game.recalc;
game.recalc = () => {
    recalcV13();
    if(G.void_upg) {
        // Void Strength (2x dmg per level)
        if(G.void_upg.v_str) G.stats.dmg *= Math.pow(2, G.void_upg.v_str);
    }
};

// Hook Dungeon Enter (Add Animation)
const enterDungeonV13 = dungeon.enter;
dungeon.enter = () => {
    if(dungeon.active) return;
    if(!confirm("Enter Dungeon?")) return;
    
    // Play Animation THEN enter
    visual.enterDungeon("BOSS RUSH", () => {
        // We manually trigger the logic from V6 dungeon.enter without the confirm box
        dungeon.active = true;
        dungeon.wave = 1;
        ui.tab('fight', document.querySelector('.nav-btn')); 
        document.getElementById('boss-ui').style.display = 'block';
        dungeon.nextWave();
    });
};

// Hook Raid Enter (Add Animation)
const raidStartV13 = raid.start;
raid.start = () => {
    raidStartV13(); // Logic
    // Only play animation if player is on fight screen
    if(document.getElementById('tab-fight').classList.contains('show')) {
         visual.enterDungeon("RAID START", null);
    }
};

// Initialize Void Data
if(!G.void_shards) G.void_shards = 0;
if(!G.void_upg) G.void_upg = {};

// Render Void Shop
ui.renderVoid = () => {
    document.getElementById('void-curr').innerText = G.void_shards;
    document.getElementById('void-gain').innerText = voidSys.calcGain();
    
    let el = document.getElementById('void-shop');
    el.innerHTML = "";
    voidSys.upgrades.forEach((u, i) => {
        let lvl = G.void_upg[u.id] || 0;
        el.innerHTML += `
            <div class="void-card">
                <div>
                    <div style="color:#e056fd; font-weight:bold">${u.n} <small style="color:#fff">Lvl ${lvl}</small></div>
                    <div style="font-size:10px; color:#aaa">${u.desc}</div>
                </div>
                <button class="btn" style="height:30px; background:#8e44ad" onclick="voidSys.buy(${i})">
                    ${u.cost} Shards
                </button>
            </div>
        `;
    });
};

// Hook Tab for Void
const tabV13 = ui.tab;
ui.tab = (id, btn) => {
    tabV13(id, btn);
    if(id === 'void') ui.renderVoid();
};

// Hook Loop for Auto-Walk speed
const loopV13 = ui.loop;
ui.loop = () => {
    loopV13();
    // Speed up game ticks if Void Speed is bought
    if(G.void_upg && G.void_upg.v_spd) {
        // Complex to speed up interval, so we simulate extra ticks
        if(Math.random() < (G.void_upg.v_spd * 0.1)) {
            // 10% chance per level to double-tick resources
            if(S.mp < G.stats.mp) S.mp++;
            // Reduce cooldowns
            if(S.cd.blast > 0) S.cd.blast -= 100;
        }
    }
};

</script>
<script>
// 1. INJECT V14 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* MINI-MAP STYLES */
    .map-container {
        background: rgba(0,0,0,0.8); height: 50px; display: flex;
        align-items: center; justify-content: center; gap: 5px;
        border-bottom: 1px solid #444; overflow: hidden; position: relative;
    }
    .map-node {
        width: 12px; height: 12px; border-radius: 50%; background: #444;
        border: 2px solid #222; position: relative; z-index: 2;
        transition: 0.5s;
    }
    .map-line {
        width: 20px; height: 2px; background: #333; margin: 0 -2px; z-index: 1;
    }
    .map-node.active { background: #f1c40f; box-shadow: 0 0 10px #f1c40f; transform: scale(1.3); }
    .map-node.cleared { background: #2ecc71; }
    .map-node.boss { border-color: #e74c3c; border-radius: 2px; transform: rotate(45deg); }
    
    /* WALK BUTTON */
    .walk-overlay {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 60; display: none; animation: popIn 0.3s;
    }
    .walk-btn {
        background: linear-gradient(to bottom, #2ecc71, #27ae60);
        border: 2px solid #fff; padding: 15px 40px; border-radius: 30px;
        font-weight: 900; font-size: 20px; color: #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer;
        text-transform: uppercase; letter-spacing: 2px;
    }
    .walk-btn:active { transform: scale(0.95); }
    @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

    /* CARD STYLES */
    .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .mob-card {
        background: #1e272e; border: 1px solid #333; border-radius: 6px;
        padding: 5px; text-align: center; position: relative; opacity: 0.5; filter: grayscale(1);
        transition: 0.3s;
    }
    .mob-card.unlocked { opacity: 1; filter: none; border-color: #f1c40f; box-shadow: inset 0 0 10px rgba(241, 196, 15, 0.2); }
    .card-bonus { font-size: 9px; color: #2ecc71; margin-top: 2px; display: none; }
    .mob-card.unlocked .card-bonus { display: block; }

    /* AUTO-WALK TOGGLE */
    .toggle-walk {
        position: absolute; bottom: 10px; right: 10px;
        font-size: 10px; background: #333; padding: 5px 10px;
        border-radius: 15px; border: 1px solid #555; cursor: pointer; opacity: 0.7;
    }
    .toggle-walk.on { background: #2ecc71; color: #000; opacity: 1; }
</style>
`);

// 2. INJECT HTML ELEMENTS

// Mini-Map (Insert before Arena)
let arena = document.getElementById('tab-fight');
arena.insertBefore(document.createElement('div'), arena.firstChild).outerHTML = `
    <div id="mini-map" class="map-container"></div>
`;

// Walk Button & Auto Toggle (Inside Arena)
document.getElementById('arena').insertAdjacentHTML('beforeend', `
    <div id="walk-ui" class="walk-overlay">
        <button class="walk-btn" onclick="travel.go()">TRAVEL >></button>
    </div>
    <div id="btn-autowalk" class="toggle-walk" onclick="travel.toggle()">üë£ Auto-Walk: OFF</div>
`);

// Bestiary Tab
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-cards" class="screen" style="padding:15px">
        <div style="text-align:center; margin-bottom:15px">
            <h2 style="color:#e17055; margin:0">BESTIARY</h2>
            <small>Collect Cards for Damage Bonuses</small>
        </div>
        <div id="card-list" class="card-grid"></div>
    </div>
`);

// Nav Button
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('cards', this)"><i>üÉè</i>CARDS</div>
`);

// 3. LOGIC SYSTEMS

const mapSys = {
    render: () => {
        let el = document.getElementById('mini-map');
        el.innerHTML = "";
        
        // Generate a 7-node visual window around current stage
        let start = Math.max(1, G.stage - 3);
        for(let i=0; i<7; i++) {
            let s = start + i;
            let isBoss = s % 5 === 0;
            let status = s < G.stage ? 'cleared' : (s === G.stage ? 'active' : '');
            
            // Add Line
            if(i > 0) el.insertAdjacentHTML('beforeend', `<div class="map-line"></div>`);
            
            // Add Node
            el.insertAdjacentHTML('beforeend', `
                <div class="map-node ${status} ${isBoss?'boss':''}"></div>
            `);
        }
    },
    update: () => {
        // Simple re-render on stage change
        mapSys.render();
    }
};

const travel = {
    auto: false,
    waiting: false,
    
    show: () => {
        travel.waiting = true;
        // If Auto-Walk is ON, skip button
        if(travel.auto) {
            setTimeout(travel.go, 800); // Small delay for loot collection
        } else {
            document.getElementById('walk-ui').style.display = 'block';
            // Hide enemy while waiting
            document.getElementById('enemy').style.opacity = 0;
        }
    },
    go: () => {
        if(!travel.waiting) return;
        travel.waiting = false;
        document.getElementById('walk-ui').style.display = 'none';
        
        // Trigger V8 Walking Animation
        world.runSequence(() => {
            combat.spawn();
            mapSys.update();
        });
    },
    toggle: () => {
        travel.auto = !travel.auto;
        let btn = document.getElementById('btn-autowalk');
        if(travel.auto) {
            btn.classList.add('on');
            btn.innerText = "üë£ Auto-Walk: ON";
            // If stuck waiting, go now
            if(travel.waiting) travel.go();
        } else {
            btn.classList.remove('on');
            btn.innerText = "üë£ Auto-Walk: OFF";
        }
    }
};

const cards = {
    list: C.mobs.map((name, i) => ({ id:i, n:name, icon: ["üêÄ","ü¶á","üê∫","ü¶Ç","üêç","üßü","üíÄ","üëπ","üë∫","üê≤","üëΩ","üëæ"][i%12] })),
    
    checkDrop: () => {
        // 5% chance to drop card of current mob
        if(Math.random() < 0.05) {
            let mIdx = (G.stage % C.mobs.length); // Assuming standard mob rotation
            if(!G.cards[mIdx]) {
                G.cards[mIdx] = true;
                fx.float("üÉè CARD FOUND!", "#e17055", "hero");
                audio.play('level');
                ui.renderCards();
                game.recalc(); // Update damage bonus
            }
        }
    },
    getBonus: () => {
        // Count unlocked cards * 10%
        let count = Object.keys(G.cards).length;
        return 1 + (count * 0.10);
    }
};

// 4. OVERRIDES & HOOKS

// Init Card Data
if(!G.cards) G.cards = {};

// Hook UI Render for Cards
ui.renderCards = () => {
    let el = document.getElementById('card-list');
    el.innerHTML = "";
    cards.list.forEach((c, i) => {
        let has = G.cards[i];
        el.innerHTML += `
            <div class="mob-card ${has?'unlocked':''}">
                <div style="font-size:24px">${c.icon}</div>
                <div style="font-size:10px; font-weight:bold">${c.n}</div>
                <div class="card-bonus">‚öîÔ∏è +10% DMG</div>
            </div>
        `;
    });
};

// Hook Tab
const tabV14 = ui.tab;
ui.tab = (id, btn) => {
    tabV14(id, btn);
    if(id === 'cards') ui.renderCards();
};

// Hook Combat Win
const winV14 = combat.win;
combat.win = () => {
    // Run previous win logic (Loot, XP, etc)
    winV14();
    
    // Check Card Drop
    cards.checkDrop();
    
    // OVERRIDE V8 SPAWN LOGIC
    // V8 tried to auto-spawn. We want to stop that and use Travel System.
    // We do this by hijacking the world.runSequence or ensuring we don't spawn instantly.
    // Since V8 triggers runSequence immediately, we rely on travel.show to intercept the VISUALS.
    
    // NOTE: V8 called `world.runSequence` which called `combat.spawn`. 
    // We need to Intercept `combat.spawn`? No, V8 calls it inside a callback.
    // Actually, V8's winV8 logic clears timeouts.
    
    // Let's force the travel button state:
    travel.show();
};

// Hook World Run Sequence (V8)
// We need to ensure that when V8 tries to run, it respects our button.
// Actually, `travel.go()` calls `world.runSequence`. 
// The issue is `winV8` calls `world.runSequence` automatically.
// We must disable V8's auto-call. 
// A cleaner way: We redefine `combat.win` completely for the movement part?
// Easier hack: We let V8 do its thing, but `world.runSequence` checks for `travel.waiting`.

const runSeqV14 = world.runSequence;
world.runSequence = (cb) => {
    // If we are waiting for user input, DO NOT RUN yet.
    // But `travel.go()` calls this function.
    // So if this function is called by `winV8` (auto), we should block it unless Auto-Walk is on.
    
    // We can't easily detect caller. 
    // Instead: we accept that `winV8` calls this. 
    // If `winV8` calls this, we want to STOP if Auto-Walk is OFF.
    
    if(!travel.auto && travel.waiting) {
        // Do nothing! Visuals are handled by travel.show()
        return; 
    }
    
    // Otherwise (Auto-Walk ON, or called by Button), run animation
    runSeqV14(cb);
};

// Hook Recalc for Card Bonus
const recalcV14 = game.recalc;
game.recalc = () => {
    recalcV14();
    let bonus = cards.getBonus();
    G.stats.dmg = Math.floor(G.stats.dmg * bonus);
};

// Init Map
mapSys.render();

</script>
<script>
// 1. INJECT V15 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* TITLE SCREEN */
    #title-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #2d3436, #000);
        z-index: 2000; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: opacity 1s;
    }
    .game-logo {
        font-size: 50px; font-weight: 900; color: #fff;
        text-shadow: 0 0 20px #3498db, 4px 4px 0 #000;
        letter-spacing: 5px; animation: floatLogo 3s infinite ease-in-out;
        margin-bottom: 20px; text-align: center;
    }
    .start-btn {
        background: transparent; border: 2px solid #fff; color: #fff;
        padding: 15px 50px; font-size: 20px; font-weight: bold;
        cursor: pointer; transition: 0.3s; animation: pulseBtn 2s infinite;
    }
    .start-btn:hover { background: #fff; color: #000; }

    /* STORY OVERLAY */
    #story-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1900; display: none;
        align-items: center; justify-content: center; padding: 40px;
    }
    .story-text {
        color: #fff; font-family: 'Courier New', monospace; font-size: 18px;
        line-height: 1.6; max-width: 600px; text-align: left;
    }
    .skip-hint {
        position: absolute; bottom: 20px; color: #555; font-size: 12px; animation: blink 1s infinite;
    }

    /* TUTORIAL WIZARD */
    .guide-box {
        position: fixed; bottom: 90px; right: 10px; width: 260px;
        background: #2c3e50; border: 2px solid #f1c40f; border-radius: 10px;
        padding: 15px; z-index: 1000; display: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slideInRight 0.5s;
    }
    .guide-face {
        position: absolute; top: -30px; left: -20px; font-size: 50px;
        filter: drop-shadow(2px 2px 0 #000);
    }
    .guide-msg { color: #fff; font-size: 12px; margin-left: 20px; }
    .guide-next {
        background: #f1c40f; border: none; padding: 5px 10px;
        margin-top: 5px; float: right; font-weight: bold; cursor: pointer;
    }

    /* ENDING CREDITS */
    .credits-roll {
        position: fixed; top: 100%; left: 0; width: 100%;
        text-align: center; color: #fff; font-weight: bold;
        animation: rollCredits 10s linear forwards; pointer-events: none; z-index: 3000;
    }

    @keyframes floatLogo { 0%,100% {transform:translateY(0)} 50% {transform:translateY(-10px)} }
    @keyframes pulseBtn { 0%,100% {opacity:1} 50% {opacity:0.7} }
    @keyframes slideInRight { from {transform:translateX(100%)} to {transform:translateX(0)} }
    @keyframes rollCredits { from {top:100%} to {top:-50%} }
</style>
`);

// 2. INJECT HTML ELEMENTS
document.body.insertAdjacentHTML('beforeend', `
    <div id="title-screen">
        <div class="game-logo">COSMIC<br>RPG</div>
        <div style="color:#aaa; margin-bottom:40px">V15: The Prophecy</div>
        <button class="start-btn" onclick="sys.startGame()">TAP TO START</button>
    </div>

    <div id="story-layer" onclick="sys.endStory()">
        <div class="story-text" id="story-txt"></div>
        <div class="skip-hint">TAP TO SKIP</div>
    </div>

    <div id="guide" class="guide-box">
        <div class="guide-face">üßô‚Äç‚ôÇÔ∏è</div>
        <div class="guide-msg" id="guide-msg"></div>
        <button class="guide-next" onclick="guide.next()">GOT IT</button>
    </div>

    <div id="ending-layer" style="position:fixed; inset:0; background:#000; z-index:2900; display:none; opacity:0; transition:opacity 2s">
        <div id="credits" class="credits-roll">
            <h1>CONGRATULATIONS</h1>
            <p>You have defeated the Omega Titan.</p>
            <br><br>
            <p>Created By</p>
            <p style="color:#3498db">YOU & GEMINI</p>
            <br><br>
            <p>Thanks for playing!</p>
        </div>
    </div>
`);

// 3. LOGIC SYSTEMS

const sys = {
    startGame: () => {
        let ts = document.getElementById('title-screen');
        ts.style.opacity = 0;
        setTimeout(() => ts.style.display = 'none', 1000);
        
        // If Level 1, play story. Else just load.
        if(G.lvl === 1 && G.stage === 1) {
            sys.playStory();
        } else {
            audio.play('level'); // Welcome back sound
        }
    },
    
    playStory: () => {
        let sl = document.getElementById('story-layer');
        let txt = document.getElementById('story-txt');
        sl.style.display = 'flex';
        
        let story = "Long ago, the world was shattered by the Void... \n\nMonsters rose from the cracks, stealing the light of the stars. \n\nYou, a lone hero, must journey through the lands, forge mighty gear, and defeat the Omega Titan to restore balance. \n\nYour destiny awaits...";
        
        let i = 0;
        let timer = setInterval(() => {
            txt.innerText += story[i];
            i++;
            if(i >= story.length) clearInterval(timer);
        }, 50);
    },
    
    endStory: () => {
        document.getElementById('story-layer').style.display = 'none';
        guide.trigger('intro');
    },
    
    triggerEnding: () => {
        let el = document.getElementById('ending-layer');
        el.style.display = 'block';
        setTimeout(() => el.style.opacity = 1, 100);
        
        // Play Credits Animation
        let cr = document.getElementById('credits');
        cr.style.animation = 'none';
        void cr.offsetWidth;
        cr.style.animation = 'rollCredits 15s linear forwards';
        
        // After credits, show Void Ascend prompt
        setTimeout(() => {
            el.style.opacity = 0;
            setTimeout(() => {
                el.style.display = 'none';
                alert("THE CYCLE CONTINUES...\nYou can now Ascend in the Void Tab!");
                ui.tab('void', document.querySelector('.nav-btn')); // Force open void
            }, 2000);
        }, 15000);
    }
};

const guide = {
    active: false,
    queue: [],
    
    trigger: (id) => {
        if(G.tutorials && G.tutorials[id]) return; // Already seen
        guide.queue.push(id);
        if(!guide.active) guide.process();
    },
    
    process: () => {
        if(guide.queue.length === 0) {
            document.getElementById('guide').style.display = 'none';
            guide.active = false;
            return;
        }
        
        guide.active = true;
        let id = guide.queue.shift();
        let msg = "";
        
        // Tutorial Scripts
        if(id === 'intro') msg = "Welcome! I am the Guide. <br>Tap <b>ATTACK</b> to fight enemies. Collect Gold to buy upgrades!";
        if(id === 'cards') msg = "This is the <b>Bestiary</b>! <br>Monsters drop cards. Cards give you +Damage against that monster!";
        if(id === 'mine') msg = "The <b>Deep Mine</b>! <br>Tap the rock to get Ore. Craft Ore into Gems for powerful upgrades.";
        if(id === 'guild') msg = "<b>Guilds</b> allow you to team up! <br>Donate gold to unlock global buffs for your character.";
        if(id === 'void') msg = "The <b>Void</b>... <br>Resetting your progress here grants Void Shards. This is the only way to get true power.";
        
        document.getElementById('guide-msg').innerHTML = msg;
        document.getElementById('guide').style.display = 'block';
        
        // Mark as seen
        if(!G.tutorials) G.tutorials = {};
        G.tutorials[id] = true;
    },
    
    next: () => {
        guide.process();
    }
};

// 4. HOOKS & OVERRIDES

// Hook Tab Switching to trigger tutorials
const tabV15 = ui.tab;
ui.tab = (id, btn) => {
    tabV15(id, btn);
    // Trigger specific tutorials
    if(id === 'cards') guide.trigger('cards');
    if(id === 'mine') guide.trigger('mine');
    if(id === 'guild') guide.trigger('guild');
    if(id === 'void') guide.trigger('void');
};

// Hook Dungeon/Boss Win for Ending
const winV15 = combat.win;
combat.win = () => {
    // Check for Omega Boss (Stage 100)
    if(G.stage === 100) {
        sys.triggerEnding();
        // Give rewards but pause auto-walk
        G.gold += 1000000;
        G.gems += 50;
        fx.float("OMEGA DEFEATED!", "#e74c3c", "hero");
        return; // Stop normal progression flow for a moment
    }
    
    winV15();
    
    // Trigger Intro Tutorial on first win if missed
    if(G.lvl === 1) guide.trigger('intro');
};

// Ensure Map and Title Screen z-index co-exist
document.getElementById('mini-map').style.zIndex = "5";

</script>
<script>
// 1. INJECT V16 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* WORLD MAP GRID */
    .world-container {
        display: flex; flex-direction: column; align-items: center;
        background: #111; padding: 10px; border-radius: 8px;
    }
    .map-grid {
        display: grid; grid-template-columns: repeat(10, 1fr);
        gap: 1px; background: #000; border: 2px solid #555;
        width: 300px; height: 300px; margin-bottom: 10px;
    }
    .tile { width: 100%; height: 100%; position: relative; }
    
    /* TERRAIN COLORS */
    .t-grass { background: #27ae60; }
    .t-water { background: #2980b9; }
    .t-mtn   { background: #7f8c8d; }
    .t-town  { background: #e67e22; }
    
    /* PLAYER & OBJECTS */
    .map-player {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff; border-radius: 50%; border: 2px solid #000;
        animation: pulsePlayer 1s infinite; z-index: 5;
    }
    .map-chest {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center; font-size: 14px;
        z-index: 4;
    }

    /* D-PAD CONTROLS */
    .dpad {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
        width: 150px; margin-top: 10px;
    }
    .dpad-btn {
        background: #333; border: 2px solid #555; border-radius: 8px;
        height: 50px; color: #fff; font-size: 20px; cursor: pointer;
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 4px 0 #000;
    }
    .dpad-btn:active { transform: translateY(3px); box-shadow: none; }
    .d-up { grid-column: 2; }
    .d-left { grid-column: 1; }
    .d-right { grid-column: 3; }
    .d-down { grid-column: 2; }

    @keyframes pulsePlayer { 0% {transform:scale(0.8)} 50% {transform:scale(1.1)} 100% {transform:scale(0.8)} }
</style>
`);

// 2. INJECT WORLD TAB
document.querySelector('.viewport').insertAdjacentHTML('beforeend', `
    <div id="tab-world" class="screen" style="padding:15px">
        <div style="text-align:center; margin-bottom:10px">
            <h2 style="color:#2ecc71; margin:0">OPEN WORLD</h2>
            <small>Explore to find Loot & Battles</small>
        </div>

        <div class="world-container">
            <div id="map-display" class="map-grid">
                </div>
            
            <div class="dpad">
                <div class="dpad-btn d-up" onclick="explore.move(0, -1)">‚¨ÜÔ∏è</div>
                <div class="dpad-btn d-left" onclick="explore.move(-1, 0)">‚¨ÖÔ∏è</div>
                <div class="dpad-btn d-right" onclick="explore.move(1, 0)">‚û°Ô∏è</div>
                <div class="dpad-btn d-down" onclick="explore.move(0, 1)">‚¨áÔ∏è</div>
            </div>
            
            <div style="margin-top:10px; font-size:10px; color:#aaa" id="loc-info">
                Location: 0, 0
            </div>
        </div>
    </div>
`);

// 3. INJECT NAV BUTTON
document.querySelector('.nav').insertAdjacentHTML('beforeend', `
    <div class="nav-btn" onclick="ui.tab('world', this)"><i>üó∫Ô∏è</i>MAP</div>
`);

// 4. EXPLORATION LOGIC
const explore = {
    w: 10, h: 10,
    px: 0, py: 0,
    // 0:Grass, 1:Water, 2:Mtn, 3:Town
    mapData: [
        0,0,0,1,1,1,0,0,2,2,
        0,0,0,1,1,1,0,0,2,2,
        0,3,0,0,0,0,0,0,0,0,
        0,0,0,0,2,2,0,0,0,0,
        1,1,0,0,2,2,0,0,1,1,
        1,1,0,0,0,0,0,0,1,1,
        0,0,0,0,0,0,0,0,0,0,
        0,0,2,2,0,0,1,1,0,0,
        0,0,2,2,0,0,1,1,0,0,
        0,0,0,0,0,0,0,0,0,0
    ],
    chests: { '8,8': true, '0,9': true, '9,0': true }, // Coordinates of chests
    
    init: () => {
        let el = document.getElementById('map-display');
        el.innerHTML = "";
        
        // Render Grid
        for(let y=0; y<explore.h; y++) {
            for(let x=0; x<explore.w; x++) {
                let idx = y * explore.w + x;
                let type = explore.mapData[idx];
                let cls = type===1?'t-water':(type===2?'t-mtn':(type===3?'t-town':'t-grass'));
                
                let tile = document.createElement('div');
                tile.className = `tile ${cls}`;
                tile.id = `tile-${x}-${y}`;
                
                // Add Chest if exists
                if(explore.chests[`${x},${y}`]) {
                    tile.innerHTML = `<div class="map-chest">üéÅ</div>`;
                }
                
                el.appendChild(tile);
            }
        }
        explore.renderPlayer();
    },
    
    renderPlayer: () => {
        // Clear old player
        let old = document.querySelector('.map-player');
        if(old) old.remove();
        
        // Add new player
        let t = document.getElementById(`tile-${explore.px}-${explore.py}`);
        if(t) {
            let p = document.createElement('div');
            p.className = 'map-player';
            t.appendChild(p);
        }
        
        // Update Text
        document.getElementById('loc-info').innerText = `Loc: ${explore.px}, ${explore.py}`;
    },
    
    move: (dx, dy) => {
        let nx = explore.px + dx;
        let ny = explore.py + dy;
        
        // Boundary Check
        if(nx < 0 || nx >= explore.w || ny < 0 || ny >= explore.h) return;
        
        // Terrain Check
        let idx = ny * explore.w + nx;
        let type = explore.mapData[idx];
        
        if(type === 1) return fx.float("Water!", "#3498db", "map-display");
        if(type === 2) return fx.float("Mountain!", "#95a5a6", "map-display");
        
        // Move
        explore.px = nx;
        explore.py = ny;
        explore.renderPlayer();
        
        // Events
        explore.checkTile();
    },
    
    checkTile: () => {
        let key = `${explore.px},${explore.py}`;
        
        // 1. CHEST
        if(explore.chests[key]) {
            delete explore.chests[key];
            let g = G.lvl * 500;
            G.gold += g;
            G.gems += 2;
            fx.float("üéÅ FOUND CHEST!", "#f1c40f", "map-display");
            audio.play('level');
            alert(`You found a Hidden Chest!\n+${g} Gold\n+2 Gems`);
            explore.init(); // Re-render to remove chest icon
            return;
        }
        
        // 2. RANDOM ENCOUNTER (20% chance on grass)
        if(Math.random() < 0.2) {
            alert("‚öîÔ∏è ENEMY ENCOUNTERED!");
            ui.tab('fight', document.querySelector('.nav-btn')); // Switch to fight
            combat.spawn(); // Spawn new enemy
        }
    }
};

// 5. HOOKS

// Hook Tab to Init Map
const tabV16 = ui.tab;
ui.tab = (id, btn) => {
    tabV16(id, btn);
    if(id === 'world') {
        // Delay slightly to ensure DOM is ready
        setTimeout(explore.init, 50);
    }
};

// Initialize
explore.init();

</script>
<script>
// 1. INJECT V16 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* D-PAD CONTROLS */
    .d-pad-container {
        position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
        display: none; grid-template-columns: 60px 60px 60px; gap: 5px;
        z-index: 80; animation: slideUp 0.3s;
    }
    .d-btn {
        background: #333; border: 2px solid #555; height: 60px; border-radius: 10px;
        color: #fff; font-size: 24px; cursor: pointer; display: flex;
        align-items: center; justify-content: center; box-shadow: 0 4px 0 #000;
    }
    .d-btn:active { transform: translateY(4px); box-shadow: none; background: #555; }
    
    /* RADAR MAP */
    .radar-box {
        position: absolute; top: 10px; left: 10px; width: 100px; height: 100px;
        background: rgba(0,0,0,0.9); border: 2px solid #2ecc71; border-radius: 6px;
        display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr);
        z-index: 70; opacity: 0.8;
    }
    .radar-cell { border: 1px solid #111; }
    .dot-p { background: #fff; border-radius: 50%; box-shadow: 0 0 5px #fff; animation: blink 1s infinite; }
    .dot-e { background: #e74c3c; border-radius: 2px; }
    .dot-L { background: #f1c40f; border-radius: 50%; transform: scale(0.6); }
    
    /* TOAST MSG */
    .explore-msg {
        position: absolute; top: 40%; width: 100%; text-align: center;
        color: #f1c40f; font-weight: bold; text-shadow: 0 2px 0 #000;
        animation: floatUpFade 1s forwards; pointer-events: none; z-index: 100;
    }
    @keyframes slideUp { from {transform:translate(-50%, 50px); opacity:0} to {transform:translate(-50%, 0); opacity:1} }
    @keyframes floatUpFade { 0% {transform:translateY(0); opacity:1} 100% {transform:translateY(-50px); opacity:0} }
</style>
`);

// 2. INJECT HTML FOR D-PAD & RADAR
document.getElementById('arena').insertAdjacentHTML('beforeend', `
    <div id="radar" class="radar-box"></div>

    <div id="d-pad" class="d-pad-container">
        <div></div>
        <div class="d-btn" onclick="explorer.move(0, -1)">‚¨ÜÔ∏è</div>
        <div></div>
        <div class="d-btn" onclick="explorer.move(-1, 0)">‚¨ÖÔ∏è</div>
        <div class="d-btn" style="background:#222; font-size:12px">WALK</div>
        <div class="d-btn" onclick="explorer.move(1, 0)">‚û°Ô∏è</div>
        <div></div>
        <div class="d-btn" onclick="explorer.move(0, 1)">‚¨áÔ∏è</div>
        <div></div>
    </div>
`);

// 3. EXPLORATION SYSTEM
const explorer = {
    x: 2, y: 2, // 0-4 Grid
    map: [], // 5x5 Grid Data
    active: false,
    
    initMap: () => {
        // Generate a 5x5 grid
        // 0 = Empty, 1 = Enemy, 2 = Loot
        explorer.map = [];
        for(let r=0; r<5; r++) {
            let row = [];
            for(let c=0; c<5; c++) {
                let val = 0;
                if(Math.random() < 0.3) val = 1; // 30% Enemy
                else if(Math.random() < 0.1) val = 2; // 10% Loot
                row.push(val);
            }
            explorer.map.push(row);
        }
        // Ensure center is empty (safe zone start)
        explorer.x = 2; explorer.y = 2;
        explorer.map[2][2] = 0; 
        explorer.renderRadar();
    },
    
    renderRadar: () => {
        let el = document.getElementById('radar');
        el.innerHTML = "";
        for(let r=0; r<5; r++) {
            for(let c=0; c<5; c++) {
                let cell = document.createElement('div');
                cell.className = 'radar-cell';
                
                if(r === explorer.y && c === explorer.x) {
                    cell.classList.add('dot-p'); // Player
                } else if (explorer.map[r][c] === 1) {
                    cell.classList.add('dot-e'); // Enemy
                } else if (explorer.map[r][c] === 2) {
                    cell.classList.add('dot-L'); // Loot
                }
                el.appendChild(cell);
            }
        }
    },
    
    move: (dx, dy) => {
        // Calculate new pos
        let nx = explorer.x + dx;
        let ny = explorer.y + dy;
        
        // Bounds Check
        if(nx < 0 || nx > 4 || ny < 0 || ny > 4) {
            fx.float("BLOCKED", "#aaa", "d-pad");
            return;
        }
        
        // Move Animation (V8 integration)
        let h = document.querySelector('#hero .f-icon');
        h.classList.add('hero-run');
        setTimeout(() => h.classList.remove('hero-run'), 200);
        
        // Update Pos
        explorer.x = nx; 
        explorer.y = ny;
        explorer.renderRadar();
        
        // Check Tile
        let tile = explorer.map[ny][nx];
        explorer.checkTile(tile);
    },
    
    checkTile: (type) => {
        // 0 = Empty
        if(type === 0) {
            // Small chance for random encounter anyway
            if(Math.random() < 0.1) explorer.encounter();
        }
        // 1 = Enemy
        else if(type === 1) {
            explorer.map[explorer.y][explorer.x] = 0; // Clear tile
            explorer.encounter();
        }
        // 2 = Loot
        else if(type === 2) {
            explorer.map[explorer.y][explorer.x] = 0; // Clear tile
            let g = G.lvl * 20;
            G.gold += g;
            explorer.msg(`FOUND CHEST! +${g}g`);
            audio.play('coin');
            explorer.renderRadar();
        }
    },
    
    encounter: () => {
        explorer.active = false;
        document.getElementById('d-pad').style.display = 'none';
        document.getElementById('radar').style.opacity = '0.3';
        document.getElementById('enemy').style.opacity = '1';
        
        // V8/V13 compatibility: Trigger spawn
        combat.spawn();
        
        // Trigger Gate animation only if Boss
        if(G.stage % 5 === 0 && visual && visual.enterDungeon) {
             visual.enterDungeon("BOSS FOUND", null);
        }
    },
    
    enable: () => {
        explorer.active = true;
        document.getElementById('d-pad').style.display = 'grid';
        document.getElementById('radar').style.opacity = '1';
        document.getElementById('enemy').style.opacity = '0'; // Hide enemy while exploring
        
        // Hide V14 Walk Button if it exists
        let wBtn = document.getElementById('walk-ui');
        if(wBtn) wBtn.style.display = 'none';
        
        explorer.msg("EXPLORE MODE");
    },
    
    msg: (txt) => {
        let el = document.createElement('div');
        el.className = 'explore-msg';
        el.innerText = txt;
        document.getElementById('arena').appendChild(el);
        setTimeout(()=>el.remove(), 1000);
    }
};

// 4. OVERRIDES & HOOKS

// Hook Start Game (Init Map)
const startV16 = sys.startGame;
sys.startGame = () => {
    startV16();
    explorer.initMap();
};

// Hook Combat Win
const winV16 = combat.win;
combat.win = () => {
    winV16();
    
    // Instead of showing "Travel" button (V14) or auto-walking (V13),
    // We enable Explorer Mode (V16)
    
    // We need to override the travel.show from V14
    // Since V14's winV14 calls travel.show(), we can hide it immediately
    setTimeout(() => {
        let wBtn = document.getElementById('walk-ui');
        if(wBtn) wBtn.style.display = 'none';
        
        // Enable D-Pad
        explorer.enable();
    }, 100); // Slight delay to ensure V14 finished its logic
};

// Hook Dungeon/Raid
// If inside Dungeon/Raid, disable exploration
const enterDungeonV16 = dungeon.enter;
dungeon.enter = () => {
    enterDungeonV16();
    document.getElementById('d-pad').style.display = 'none';
    document.getElementById('radar').style.display = 'none';
};

const winDungeonV16 = dungeon.win;
dungeon.win = () => {
    winDungeonV16();
    document.getElementById('radar').style.display = 'grid';
    // Return to exploration
    explorer.enable();
};

// Initial Map Gen
explorer.initMap();

</script>
<script>
/* =========================================
   V17: GOLD MASTER (POLISH & SETTINGS)
   ========================================= */

// 1. INJECT V17 STYLES
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* SETTINGS BUTTON */
    .settings-icon {
        position: absolute; top: 10px; right: 10px;
        font-size: 24px; cursor: pointer; z-index: 200;
        filter: drop-shadow(0 0 5px #000); transition: transform 0.2s;
    }
    .settings-icon:hover { transform: rotate(90deg); }

    /* OFFLINE MODAL */
    .offline-modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.95);
        z-index: 5000; display: none; justify-content: center; align-items: center;
        flex-direction: column; text-align: center;
    }
    .offline-box {
        background: #2d3436; border: 2px solid #f1c40f; padding: 30px;
        border-radius: 10px; box-shadow: 0 0 50px #f1c40f;
        animation: popIn 0.5s;
    }

    /* SETTINGS MODAL */
    .set-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px; border-bottom: 1px solid #444; width: 100%; gap: 20px;
    }
    .toggle {
        width: 40px; height: 20px; background: #555; border-radius: 10px;
        position: relative; cursor: pointer; transition: 0.3s;
    }
    .toggle.on { background: #2ecc71; }
    .toggle-knob {
        width: 16px; height: 16px; background: #fff; border-radius: 50%;
        position: absolute; top: 2px; left: 2px; transition: 0.3s;
    }
    .toggle.on .toggle-knob { left: 22px; }
</style>
`);

// 2. INJECT UI ELEMENTS
// Settings Icon
document.body.insertAdjacentHTML('beforeend', `
    <div class="settings-icon" onclick="settings.open()">‚öôÔ∏è</div>
`);

// Offline Modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="offline-screen" class="offline-modal">
        <div class="offline-box">
            <h2 style="color:#f1c40f; margin:0">WELCOME BACK</h2>
            <p style="color:#aaa">While you were sleeping...</p>
            <div style="font-size:24px; margin:20px 0">
                TIME: <span id="off-time" style="color:#fff">0h</span><br>
                GOLD: <span id="off-gold" style="color:#f1c40f">0</span><br>
                XP: <span id="off-xp" style="color:#3498db">0</span>
            </div>
            <button class="btn" style="background:#2ecc71; width:100%" onclick="document.getElementById('offline-screen').style.display='none'">COLLECT</button>
        </div>
    </div>
`);

// Settings Modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="settings-modal" class="modal">
        <div class="modal-c">
            <div style="text-align:right; font-size:24px; cursor:pointer" onclick="document.getElementById('settings-modal').style.display='none'">√ó</div>
            <h2 style="color:#fff">SETTINGS</h2>
            
            <div class="set-row">
                <span>üîä Sound FX</span>
                <div id="t-sfx" class="toggle on" onclick="settings.toggle('sfx')"><div class="toggle-knob"></div></div>
            </div>
            
            <div class="set-row">
                <span>‚ú® Particles (Lag Fix)</span>
                <div id="t-part" class="toggle on" onclick="settings.toggle('part')"><div class="toggle-knob"></div></div>
            </div>

            <div class="set-row">
                <span>üë£ AFK Mode (Auto-Walk)</span>
                <div id="t-afk" class="toggle" onclick="settings.toggle('afk')"><div class="toggle-knob"></div></div>
            </div>
            
            <hr style="border-color:#333; margin:20px 0">
            
            <button class="btn" style="background:#3498db; margin-bottom:10px" onclick="settings.export()">üìã EXPORT SAVE</button>
            <button class="btn" style="background:#e74c3c" onclick="game.hardReset()">‚ò†Ô∏è WIPE SAVE</button>
        </div>
    </div>
`);

// 3. LOGIC SYSTEMS

const settings = {
    data: { sfx: true, part: true, afk: false },
    
    init: () => {
        // Load settings if exist
        if(G.settings) settings.data = G.settings;
        else G.settings = settings.data;
        
        settings.updateUI();
    },
    
    open: () => {
        settings.updateUI();
        document.getElementById('settings-modal').style.display = 'flex';
    },
    
    toggle: (key) => {
        settings.data[key] = !settings.data[key];
        G.settings = settings.data;
        settings.updateUI();
        
        // Immediate Effects
        if(key === 'afk') {
            if(settings.data.afk) {
                // Turn OFF Exploration, Turn ON Auto-Walk
                explorer.active = false;
                document.getElementById('d-pad').style.display = 'none';
                document.getElementById('radar').style.display = 'none';
                travel.auto = true; // V14 Auto
                travel.go(); // Force start
            } else {
                travel.auto = false;
            }
        }
    },
    
    updateUI: () => {
        ['sfx', 'part', 'afk'].forEach(k => {
            let el = document.getElementById('t-'+k);
            if(settings.data[k]) el.classList.add('on');
            else el.classList.remove('on');
        });
    },
    
    export: () => {
        let str = btoa(JSON.stringify(G));
        navigator.clipboard.writeText(str).then(() => {
            alert("Save copied to clipboard!");
        });
    }
};

const offline = {
    check: () => {
        let now = Date.now();
        if(G.lastSave) {
            let diff = now - G.lastSave; // ms
            // Minimum 1 minute
            if(diff > 60000) {
                let seconds = diff / 1000;
                
                // Calculate Rates
                // Very rough estimation based on Stage
                let gps = Math.floor(G.stage * 2); // Gold per sec
                let xps = Math.floor(G.stage * 1); // XP per sec
                
                let gainG = Math.floor(seconds * gps);
                let gainX = Math.floor(seconds * xps);
                
                // Cap at 24 hours
                if(seconds > 86400) {
                    gainG = Math.floor(86400 * gps);
                    gainX = Math.floor(86400 * xps);
                }
                
                G.gold += gainG;
                G.xp += gainX;
                
                // Show UI
                document.getElementById('off-time').innerText = (seconds/3600).toFixed(1) + "h";
                document.getElementById('off-gold').innerText = gainG;
                document.getElementById('off-xp').innerText = gainX;
                document.getElementById('offline-screen').style.display = 'flex';
            }
        }
        G.lastSave = now;
    }
};

// 4. OVERRIDES AND HOOKS

// Hook Audio (Respect Settings)
const playV17 = audio.play;
audio.play = (type) => {
    if(settings.data.sfx) playV17(type);
};

// Hook Particles (Respect Settings)
const spawnParticlesV17 = spawnParticles; // From V9
spawnParticles = (col) => {
    if(settings.data.part) spawnParticlesV17(col);
};

// Hook Save (Update Timestamp)
const saveV17 = game.save;
game.save = () => {
    G.lastSave = Date.now();
    G.settings = settings.data; // Ensure settings are saved
    saveV17();
};

// Hook Game Start (Check Offline & Init Settings)
const startV17 = sys.startGame;
sys.startGame = () => {
    startV17();
    settings.init();
    offline.check();
};

// Hook Win (Handle AFK Logic conflict)
const winV17 = combat.win;
combat.win = () => {
    winV17();
    // If AFK Mode is enabled in settings, bypass V16 Explorer Mode
    if(settings.data.afk) {
        // Hide Explorer UI just in case
        document.getElementById('d-pad').style.display = 'none';
        document.getElementById('radar').style.display = 'none';
        
        // Force V14 Travel logic
        travel.waiting = true; 
        travel.go();
    }
};

// Apply Settings immediately if loaded
if(G.settings) settings.data = G.settings;

</script>
<script>
/* =========================================
   V18: GOLD MASTER (POLISH, FORMATTING, & SAFETY)
   ========================================= */

// 1. INJECT FINAL STYLES (Fonts & Polish)
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* IMPORT GAMING FONT */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

    /* GLOBAL FONT OVERRIDE */
    body { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
    
    /* SAVE INDICATOR */
    #save-indicator {
        position: fixed; bottom: 10px; left: 10px; font-size: 10px;
        color: #7f8c8d; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 9999;
    }
    #save-indicator.show { opacity: 1; }

    /* NUMBER FORMATTING CLASS */
    .fmt-num { font-variant-numeric: tabular-nums; }
</style>
`);

// 2. INJECT SAVE ICON
document.body.insertAdjacentHTML('beforeend', `<div id="save-indicator">üíæ SAVED</div>`);

// 3. UTILITY: BIG NUMBER FORMATTER (1k, 1M, 1B, 1T)
const fmt = (n) => {
    if (n >= 1e12) return (n / 1e12).toFixed(2) + "T";
    if (n >= 1e9) return (n / 1e9).toFixed(2) + "B";
    if (n >= 1e6) return (n / 1e6).toFixed(2) + "M";
    if (n >= 1e3) return (n / 1e3).toFixed(2) + "k";
    return Math.floor(n).toLocaleString();
};

// 4. OVERRIDE VOID ASCENSION (Fixing the Reset Logic)
// Previous versions didn't know about Farming/Maps. This ensures a CLEAN reset.
voidSys.ascend = () => {
    let gain = voidSys.calcGain();
    if(gain <= 0) return alert("Reach Stage 100 first!");
    
    if(confirm(`Reset world for ${gain} Void Shards?`)) {
        // 1. SAVE PERMANENT DATA
        let keep = {
            gems: G.gems,
            void_shards: (G.void_shards || 0) + gain,
            void_upg: G.void_upg || {},
            guild_lvl: G.guild_lvl,
            guild_xp: G.guild_xp,
            pets: G.pets,
            activePet: G.activePet,
            cards: G.cards,
            settings: G.settings,
            tutorials: G.tutorials,
            pacts: G.pacts // Blood pacts are permanent? Usually yes, let's keep them dangerous/permanent
        };

        // 2. RESET GAME OBJECT (G) TO DEFAULT
        // We manually reconstruct G to avoid missing hidden variables
        G = {
            // Base
            gold: 0, lvl: 1, xp: 0, max_xp: 100, 
            stage: 1 + (keep.void_upg.v_start||0)*10, // Head Start Perk
            stats: { dmg: 10, hp: 100, mp: 50 },
            
            // Systems Reset
            upg: { dmg:0, hp:0, regen:0, greed:0 },
            perm: { g_dmg:0, g_xp:0, g_auto:0 },
            mine: { ore:0, lvl:1, xp:0 },
            runes: { fire:0, ice:0, storm:0 },
            spells: {},
            quests: [],
            seeds: 0,
            
            // Restore Permanents
            ...keep
        };

        // 3. RE-INIT SYSTEMS
        quests.gen(); // New Quests
        if(explorer && explorer.initMap) explorer.initMap(); // Reset Map
        
        // 4. VISUAL TRANSITION
        visual.enterDungeon("ASCENSION", () => {
            game.save();
            location.reload();
        });
    }
};

// 5. OVERRIDE UI LOOP (Apply Formatting)
const loopFinal = ui.loop;
ui.loop = () => {
    loopFinal(); // Run logic
    
    // FORMAT HUD NUMBERS
    document.getElementById('hud-gold').innerText = fmt(G.gold);
    document.getElementById('hud-gem').innerText = fmt(G.gems);
    
    // FORMAT SHOP COSTS
    C.upgrades.forEach(u => {
        let el = document.getElementById(`u_cost_${u.id}`);
        // Parse the raw number back out (or recalc) to check format
        // Simpler: Just recalculate cost to display formatted
        let lvl = G.upg[u.id];
        let cost = Math.floor(u.base * Math.pow(u.m, lvl));
        if(el) el.innerText = fmt(cost);
    });

    // FORMAT MINING
    let oreEl = document.getElementById('mine-ore');
    if(oreEl) oreEl.innerText = fmt(G.mine.ore);
};

// 6. PERFORMANCE & SAVE NOTIFICATION
// Modify Save to show icon
const saveFinal = game.save;
game.save = () => {
    saveFinal();
    let el = document.getElementById('save-indicator');
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
};

// Limit Floating Text (Performance Fix)
// If there are too many numbers floating, remove the old ones
const fxFloatFinal = fx.float;
fx.float = (txt, col, parentId) => {
    // Check count
    let count = document.getElementsByClassName('pop-text').length;
    if(count > 20) {
        // Remove oldest
        document.querySelector('.pop-text').remove();
    }
    // Run original
    fxFloatFinal(txt, col, parentId);
};

// 7. FINAL BALANCING
// Ensure stage 1 isn't too boring (Give starter gold if 0)
if(G.gold === 0 && G.lvl === 1 && G.stage === 1) {
    G.gold = 10; // Enough for first upgrade
}

console.log("V18 GOLD MASTER LOADED");
</script>
<script>
/* =========================================
   V19: LAUNCH EDITION (FINAL POLISH)
   ========================================= */

// 1. INJECT FINAL STYLES (Starfield & UI Tweaks)
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* STARFIELD BACKGROUND */
    .starfield {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; pointer-events: none;
        background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
        overflow: hidden;
    }
    .star {
        position: absolute; width: 2px; height: 2px; background: #fff;
        border-radius: 50%; opacity: 0; animation: twinkle var(--dur) infinite;
    }
    @keyframes twinkle { 0% {opacity:0; transform:scale(0.5)} 50% {opacity:var(--op); transform:scale(1)} 100% {opacity:0; transform:scale(0.5)} }

    /* BUY MULTIPLIER TOGGLE */
    .buy-mult-btn {
        background: #34495e; color: #fff; border: 1px solid #7f8c8d;
        padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;
        cursor: pointer; position: absolute; top: 10px; right: 10px;
    }
    .buy-mult-btn:hover { background: #2c3e50; }

    /* MOBILE PREVENTIONS */
    * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    
    /* VERSION STAMP */
    .ver-tag {
        position: fixed; bottom: 2px; right: 5px; font-size: 8px; color: #444; 
        pointer-events: none; z-index: 9999; font-family: monospace;
    }
</style>
`);

// 2. INJECT BACKGROUND & VERSION
document.body.insertAdjacentHTML('afterbegin', `<div id="bg-stars" class="starfield"></div>`);
document.body.insertAdjacentHTML('beforeend', `<div class="ver-tag">v1.0.0 RELEASE</div>`);

// 3. INJECT BUY MULTIPLIER BUTTON
// We inject this into the Upgrade Tab Header
setTimeout(() => {
    let upgHeader = document.querySelector('#tab-upg h2');
    if(upgHeader) {
        let container = upgHeader.parentElement;
        container.style.position = 'relative';
        container.insertAdjacentHTML('beforeend', `
            <button class="buy-mult-btn" onclick="ui.toggleMult()">BUY: <span id="buy-mode">1x</span></button>
        `);
    }
}, 1000); // Delay to ensure DOM exists

// 4. STARFIELD GENERATOR
const stars = {
    init: () => {
        let el = document.getElementById('bg-stars');
        for(let i=0; i<100; i++) {
            let s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random() * 100 + "vw";
            s.style.top = Math.random() * 100 + "vh";
            s.style.setProperty('--dur', (Math.random() * 3 + 2) + "s");
            s.style.setProperty('--op', (Math.random() * 0.8 + 0.2));
            s.style.animationDelay = (Math.random() * 5) + "s";
            el.appendChild(s);
        }
    }
};

// 5. BULK BUY LOGIC
let buyMode = 1; // 1, 10, 100 (Max logic handled dynamically)

// OVERRIDE UI.BUYUPG
const oldBuy = ui.buyUpg; // Keep ref just in case, but we are replacing logic
ui.buyUpg = (id) => {
    let u = C.upgrades.find(x => x.id === id);
    let loops = (buyMode === 'MAX') ? 100 : buyMode; // Cap max loop at 100 for performance
    
    // Attempt to buy 'loops' times
    let count = 0;
    for(let i=0; i<loops; i++) {
        let lvl = G.upg[id];
        let cost = Math.floor(u.base * Math.pow(u.m, lvl));
        
        if(G.gold >= cost) {
            G.gold -= cost;
            G.upg[id]++;
            count++;
        } else {
            break; // Can't afford anymore
        }
    }
    
    if(count > 0) {
        game.recalc();
        // Optional: Play sound only once
        if(audio && audio.play) audio.play('coin');
    }
};

// EXTEND UI
ui.toggleMult = () => {
    if(buyMode === 1) buyMode = 10;
    else if(buyMode === 10) buyMode = 'MAX';
    else buyMode = 1;
    
    document.getElementById('buy-mode').innerText = buyMode + (buyMode!=='MAX'?'x':'');
    ui.loop(); // Force refresh text
};

// OVERRIDE UI LOOP TO SHOW COST OF BULK
const loopV19 = ui.loop;
ui.loop = () => {
    loopV19();
    
    // Update Upgrade Button Texts based on Multiplier
    C.upgrades.forEach(u => {
        let el = document.getElementById(`u_cost_${u.id}`);
        if(el) {
            let lvl = G.upg[u.id];
            let totalCost = 0;
            let pGold = G.gold; // Simulate without spending
            
            let loops = (buyMode === 'MAX') ? 999 : buyMode;
            let canBuy = 0;
            
            // Calculate hypothetical cost
            // Note: Geometric series formula is cleaner, but loop is safer for existing logic compatibility
            let tempLvl = lvl;
            for(let i=0; i<loops; i++) {
                let c = Math.floor(u.base * Math.pow(u.m, tempLvl));
                if(buyMode === 'MAX') {
                    if(pGold >= c) {
                        pGold -= c;
                        totalCost += c;
                        tempLvl++;
                        canBuy++;
                    } else {
                        break;
                    }
                } else {
                    totalCost += c;
                    tempLvl++;
                }
            }
            
            // Display
            if(buyMode === 'MAX') {
                if(canBuy === 0) {
                    // Show cost of next 1
                    let nextC = Math.floor(u.base * Math.pow(u.m, lvl));
                    el.innerText = fmt(nextC);
                    el.parentElement.style.opacity = 0.5;
                } else {
                    el.innerText = fmt(totalCost) + ` (+${canBuy})`;
                    el.parentElement.style.opacity = 1;
                }
            } else {
                el.innerText = fmt(totalCost);
                // Dim button if can't afford total
                if(G.gold < totalCost) el.parentElement.style.opacity = 0.5;
                else el.parentElement.style.opacity = 1;
            }
        }
    });
};

// 6. INITIALIZE
stars.init();
console.log("GAME LAUNCHED: V1.0.0");

</script>
<script>
/* =========================================
   V20: GOLDEN MASTER (POLISH & LAUNCH)
   ========================================= */

// 1. INJECT FINAL VISUAL POLISH
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* CUSTOM SCROLLBARS (Webkit) */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #f1c40f; }

    /* UNIVERSAL FONT FIX */
    button, input, textarea, select { font-family: 'Roboto Mono', monospace; }

    /* LOADING OVERLAY */
    #loader {
        position: fixed; inset: 0; background: #000; z-index: 10000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s;
    }
    .loader-spin {
        width: 50px; height: 50px; border: 5px solid #333;
        border-top: 5px solid #f1c40f; border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    
    /* PREVENT TEXT SELECTION EVERYWHERE */
    body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

    @keyframes spin { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
</style>
`);

// 2. INJECT LOADER HTML
document.body.insertAdjacentHTML('afterbegin', `
    <div id="loader">
        <div class="loader-spin"></div>
        <div style="color:#fff; font-weight:bold; letter-spacing:2px">LOADING ASSETS...</div>
        <div id="loader-ver" style="color:#666; font-size:10px; margin-top:10px">v1.0.0</div>
    </div>
`);

// 3. SYSTEM: TITLE UPDATER
const docTitle = {
    update: () => {
        // Updates browser tab: "Lvl 10 | 500g - Cosmic RPG"
        document.title = `Lvl ${G.lvl} | ${fmt(G.gold)}g - Cosmic RPG`;
    }
};

// 4. SYSTEM: GARBAGE COLLECTOR (Performance)
const gc = {
    clean: () => {
        // Remove stuck particles
        let parts = document.querySelectorAll('.spark');
        if(parts.length > 20) {
            parts.forEach((p, i) => { if(i < parts.length - 10) p.remove(); });
        }
        
        // Remove stuck floating text
        let floats = document.querySelectorAll('.pop-text');
        if(floats.length > 15) {
            floats.forEach((f, i) => { if(i < floats.length - 10) f.remove(); });
        }

        // Remove stuck rain
        let rain = document.querySelectorAll('.rain-drop');
        if(village.state !== 'rain' && rain.length > 0) {
            rain.forEach(r => r.remove());
        }
    }
};

// 5. ENHANCED SAVE SYSTEM (Safety)
// We wrap the load function to prevent white-screen crashes on bad data
const safeLoad = game.load;
game.load = () => {
    try {
        let d = localStorage.getItem(C.ver);
        if(d) {
            // Check for NaN or Nulls in critical stats
            let check = JSON.parse(d);
            if(check.stats && isNaN(check.stats.hp)) throw "Corrupted HP";
            
            // Proceed to load
            safeLoad();
            console.log("Save Loaded Successfully");
        }
    } catch (e) {
        console.error("Save Corrupted:", e);
        alert("Warning: Save file appeared corrupted. Attempting to restore backup or defaults.");
        // We don't overwrite G here, effectively starting fresh or partial
    }
};

// 6. HOOKS & FINAL INITIALIZATION

// Hook Loop for Title & GC
const loopV20 = ui.loop;
let gcTimer = 0;

ui.loop = () => {
    loopV20(); // Run all previous V1-V19 logic
    
    // Update Title every 1 second (10 ticks)
    if(G.ticks % 10 === 0) docTitle.update();
    
    // Run Garbage Collector every 5 seconds
    if(G.ticks % 50 === 0) gc.clean();
};

// 7. LAUNCH SEQUENCE
// We simulate a loading time to ensure all styles/scripts settled
window.onload = () => {
    setTimeout(() => {
        let l = document.getElementById('loader');
        l.style.opacity = 0;
        setTimeout(() => {
            l.style.display = 'none';
            
            // If new player, trigger Title Screen animation from V15
            if(G.lvl === 1 && G.stage === 1) {
                // V15 logic handles the start button
            } else {
                // Remove Title Screen for returning players
                let ts = document.getElementById('title-screen');
                if(ts) ts.style.display = 'none';
                audio.play('level'); // Ready sound
                fx.float("GAME LOADED", "#2ecc71", "hero");
            }
            
        }, 500);
    }, 1500); // 1.5s Fake Load time for dramatic effect
};

// Prevent Right Click Context Menu (Feels more like an app)
document.addEventListener('contextmenu', event => event.preventDefault());

console.log("%c COSMIC RPG V1.0 - READY ", "background: #f1c40f; color: #000; font-size: 20px; padding: 10px;");

</script>
<script>
/* =========================================
   V21: RELEASE CANDIDATE (HOTFIXES & POLISH)
   ========================================= */

// 1. DYNAMIC FAVICON GENERATOR (Pro Polish)
// This creates a custom icon for the browser tab without needing an external image file.
const setFavicon = () => {
    const canvas = document.createElement('canvas');
    canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d');
    
    // Background
    ctx.fillStyle = '#111';
    ctx.beginPath();
    ctx.arc(32, 32, 32, 0, 2*Math.PI);
    ctx.fill();
    
    // Icon
    ctx.font = '40px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('üßô‚Äç‚ôÇÔ∏è', 32, 34);
    
    const link = document.createElement('link');
    link.type = 'image/x-icon';
    link.rel = 'shortcut icon';
    link.href = canvas.toDataURL();
    document.getElementsByTagName('head')[0].appendChild(link);
};
setFavicon();

// 2. MOBILE APP META TAGS
// This makes the game look like a native app when "Added to Home Screen" on iOS/Android.
document.head.insertAdjacentHTML("beforeend", `
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
`);

// 3. AUDIO CONTEXT FIX (The "Autoplay" Bug)
// Browsers block AudioContext if created before user interaction. 
// We must rebuild the audio engine to initialize ONLY after the first click.
const safeAudio = {
    ctx: null,
    init: () => {
        if(!safeAudio.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            safeAudio.ctx = new AudioContext();
            console.log("Audio Engine Started");
        }
        if(safeAudio.ctx.state === 'suspended') {
            safeAudio.ctx.resume();
        }
    },
    play: (type) => {
        if(!G.settings.sfx) return; // Respect settings
        if(!safeAudio.ctx) return; // Wait for init
        
        const ctx = safeAudio.ctx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        const now = ctx.currentTime;
        
        // Sound Profiles
        if (type === 'hit') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'coin') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.linearRampToValueAtTime(1600, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'level') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(220, now);
            osc.frequency.linearRampToValueAtTime(880, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.4);
            osc.start(now); osc.stop(now + 0.4);
        }
    }
};
// Overwrite the V10/V17 audio engine with this safe one
audio.play = safeAudio.play; 

// 4. UNIFIED MOVEMENT LOGIC (Fixing V14 vs V16 vs V17)
// We need a master controller to decide what happens when you win a fight.
const masterWin = combat.win; // Save previous chain
combat.win = () => {
    // 1. Run standard win logic (loot, XP, etc)
    masterWin(); 
    
    // 2. Clear visual conflicts
    document.getElementById('walk-ui').style.display = 'none'; // Hide V14 Button
    
    // 3. DECISION TREE
    if (dungeon.active || raid.active) {
        // CASE A: Inside Dungeon/Raid
        // Do nothing, dungeon logic handles next wave.
        return; 
    } 
    
    if (settings.data.afk) {
        // CASE B: AFK Mode is ON (Priority 1)
        // Disable Explorer D-Pad, Force Auto-Walk
        if(explorer && explorer.active) {
            document.getElementById('d-pad').style.display = 'none';
            document.getElementById('radar').style.display = 'none';
        }
        // Force V14 Travel logic
        travel.waiting = true; 
        travel.go();
        return;
    }
    
    // CASE C: Standard Gameplay
    // Default to Explorer Mode (V16)
    explorer.enable();
};

// 5. HOOK AUDIO INIT TO START BUTTON
const finalStart = sys.startGame;
sys.startGame = () => {
    safeAudio.init(); // Initialize sound engine on user gesture
    finalStart();
};

// 6. RENDER PERFORMANCE TWEAK
// Only render heavy UI elements if the specific tab is open to save battery
const optimizedLoop = ui.loop;
ui.loop = () => {
    // Always run core loop
    optimizedLoop();
    
    // Only render map if map tab is open
    const mapTab = document.getElementById('tab-world');
    if(!mapTab.classList.contains('show')) {
        // Skip map heavy logic if hidden
    }
};

console.log("%c V21 RELEASE PATCH APPLIED ", "background: #2ecc71; color: #000; font-weight: bold;");

</script>
<script>
/* =========================================
   V22: RELEASE CANDIDATE (OPTIMIZATION & STABILITY)
   ========================================= */

console.log("%c INITIATING FINAL OPTIMIZATION... ", "background: #000; color: #f1c40f; font-size: 14px;");

// 1. PERFORMANCE: REQUEST ANIMATION FRAME (The Loop Fix)
// Instead of chaotic setIntervals, we use the browser's native frame scheduler.
// This creates buttery smooth animations and stops the game from draining battery in the background.

const engine = {
    running: true,
    lastTime: 0,
    fps: 0,
    frames: 0,
    fpsTime: 0,
    
    loop: (timestamp) => {
        if(!engine.running) return;
        requestAnimationFrame(engine.loop);
        
        const deltaTime = timestamp - engine.lastTime;
        engine.lastTime = timestamp;
        
        // Calculate FPS
        engine.frames++;
        if(timestamp > engine.fpsTime + 1000) {
            engine.fps = engine.frames;
            engine.frames = 0;
            engine.fpsTime = timestamp;
            // Only update FPS UI if it exists (debug mode)
            // console.log("FPS:", engine.fps); 
        }

        // We don't want to break the existing 100ms interval logic you built,
        // so we won't replace the logic loop, but we WILL handle the rendering here.
        // This forces UI updates to sync with screen refresh rate.
    }
};
requestAnimationFrame(engine.loop);

// 2. ERROR HANDLING (Crash Protection)
// If the game crashes in the wild, the user usually gets a white screen.
// This catches the error and lets them save their progress.
window.onerror = function(msg, url, lineNo, columnNo, error) {
    // Ignore benign resize/scroll errors
    if(msg.indexOf('ResizeObserver') > -1) return;
    
    const errBox = document.createElement('div');
    errBox.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; color:red; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;";
    
    errBox.innerHTML = `
        <h2 style="margin-bottom:10px">‚ö†Ô∏è GAME ERROR</h2>
        <p style="color:#fff; font-family:monospace; font-size:10px; max-width:80%">${msg}</p>
        <p style="color:#aaa; margin-top:20px">Don't worry, your save is safe.</p>
        <button onclick="settings.export()" style="padding:15px; background:#f1c40f; color:#000; border:none; font-weight:bold; border-radius:5px; margin-top:10px;">COPY SAVE DATA</button>
        <button onclick="location.reload()" style="padding:15px; background:#333; color:#fff; border:1px solid #fff; font-weight:bold; border-radius:5px; margin-top:10px;">RELOAD GAME</button>
    `;
    
    document.body.appendChild(errBox);
    return false;
};

// 3. AUDIO UNLOCKER (The "Silent" Bug Fix)
// Browsers block audio until a user clicks. This invisible overlay ensures
// the first click anywhere on the screen unlocks the audio engine.
const audioUnlocker = document.createElement('div');
audioUnlocker.id = "audio-unlock-overlay";
audioUnlocker.style.cssText = "position:fixed; inset:0; z-index:99998; background:transparent;";
audioUnlocker.onclick = () => {
    if(safeAudio && safeAudio.init) safeAudio.init();
    if(audio && audio.ctx && audio.ctx.resume) audio.ctx.resume();
    audioUnlocker.remove(); // Self destruct after first click
    console.log("Audio Context Unlocked");
};
document.body.appendChild(audioUnlocker);

// 4. LOGIC RESOLVER (Fixing the Conflict between V14, V16, V17)
// We need to enforce a Strict State Hierarchy for movement.
// Priority: 1. Dungeon/Raid (Locked) -> 2. AFK Mode (Auto) -> 3. Manual (Explorer)

// We override the combat.win one last time to be the authority.
const finalWinLogic = combat.win; 
combat.win = () => {
    // 1. Core Logic (XP, Gold, Stats)
    // We manually execute the base logic to avoid 20 layers of recursion stack
    // (Simulating the critical parts of previous wins to reduce lag)
    
    // Clear Boss Timer
    clearInterval(S.boss_tmr);
    
    // Gold/XP Calc
    let gold = Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1));
    let xp = 20 + (G.stage * 5);
    
    // Modifiers (V5, V7, V11, V12, V14, V16)
    if(G.perm.g_xp) xp *= 1.5; // V5
    if(village.state === 'night') xp += (20 + G.stage * 5); // V11
    if(G.guild_lvl >= 1) gold += Math.floor((10 + G.stage) * 0.1); // V12
    
    // Apply
    G.gold += gold;
    G.xp += xp;
    fx.float("+"+fmt(gold)+"g", "#f1c40f", "hero");

    // Level Up Check
    if(G.xp >= G.max_xp) {
        G.lvl++; G.xp=0; G.max_xp *= 1.2;
        game.recalc();
        S.hp = G.stats.hp;
        fx.float("LEVEL UP!", "#3498db", "hero");
        audio.play('level');
    }

    // Drops (V5, V7, V11, V14)
    if(Math.random() < ((G.stage%5===0)?0.05:0.001)) { G.gems++; fx.float("üíé GEM!", "#e84393", "hero"); }
    if(Math.random() < 0.3) { // Runes V7
        let type = Math.random()<0.33?'fire':(Math.random()<0.66?'ice':'storm');
        G.runes[type]++;
    }
    if(Math.random() < 0.2) G.seeds++; // V11
    if(cards && cards.checkDrop) cards.checkDrop(); // V14

    // Quests V7
    quests.check('kill', 1);
    quests.check('gold', gold);
    
    // --- MOVEMENT STATE MACHINE ---
    
    // State 1: Dungeon or Raid (Do nothing, allow internal logic to run)
    if(dungeon.active || raid.active) {
        // Dungeon handles its own spawning
        return; 
    }

    // State 2: Boss Win (Omega Titan V15)
    if(G.stage === 100) {
        sys.triggerEnding();
        return;
    }

    // State 3: Normal Progression
    G.stage++;
    audio.play('coin');

    // State 4: Movement Choice
    if(settings.data.afk) {
        // AFK MODE: Force Auto-Walk (V14 style)
        travel.waiting = true;
        travel.go();
    } else {
        // ACTIVE MODE: Enable Explorer (V16 style)
        explorer.enable();
    }
};

// 5. CSS POLISH (Final Visual Tweaks)
const stylePatch = document.createElement('style');
stylePatch.innerHTML = `
    /* Prevent dragging images (better mobile experience) */
    img, div { -webkit-user-drag: none; user-drag: none; }
    
    /* Better Button Presses */
    .btn:active, .d-btn:active { transform: scale(0.95) translateY(2px); }
    
    /* Hide scrollbars on main viewport but allow scrolling */
    .viewport { -ms-overflow-style: none; scrollbar-width: none; }
    .viewport::-webkit-scrollbar { display: none; }
    
    /* Fix weird highlighting on Android */
    * { -webkit-tap-highlight-color: rgba(0,0,0,0); }
`;
document.head.appendChild(stylePatch);

// 6. GARBAGE COLLECTION TWEAK (Prevent lag over time)
// Aggressively clean up DOM nodes every 2 seconds
setInterval(() => {
    // Limit total particles to 10
    const sparks = document.querySelectorAll('.spark');
    if(sparks.length > 10) {
        for(let i=0; i<sparks.length-10; i++) sparks[i].remove();
    }
    // Limit floating text to 8
    const texts = document.querySelectorAll('.pop-text');
    if(texts.length > 8) {
        for(let i=0; i<texts.length-8; i++) texts[i].remove();
    }
}, 2000);

console.log("%c SYSTEM READY. GOOD LUCK, HERO. ", "background: #2ecc71; color: #000; font-size: 16px; font-weight: bold;");
</script>
<script>
/* =========================================
   V23: FINAL POLISH & OPTIMIZATION SUITE
   ========================================= */

console.log("%c APPLYING FINAL POLISH... ", "background: #8e44ad; color: #fff; font-weight: bold;");

// 1. CSS OPTIMIZATIONS (Fixes text selection & mobile tap highlight)
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* Prevent blue highlight on mobile tap */
    * { -webkit-tap-highlight-color: transparent; }
    
    /* Prevent text selection game-wide (except inputs) */
    body { user-select: none; -webkit-user-select: none; }
    
    /* Hardware Acceleration for animations */
    .f-icon, .spark, .pop-text, .rain-drop { 
        will-change: transform, opacity; 
        transform: translateZ(0); 
    }
    
    /* Better Button States */
    .btn:active { filter: brightness(0.8); transform: translateY(2px); }
</style>
`);

// 2. MATH SANITIZER (Fixes V1-V5 Math Bugs)
// Prevents NaN (Not a Number), Negative Gold, or Infinite Health glitches.
const mathFix = {
    // Ensures a number is valid and non-negative
    safe: (n) => {
        if (isNaN(n) || n === null || n === undefined) return 0;
        return Math.max(0, Number(n));
    },
    // Fixes floating point errors (e.g. 10.000000001 -> 10)
    round: (n) => Math.round(n * 100) / 100
};

// 3. OVERRIDE CORE LOGIC (Flattening Recursion)
// We are replacing the deeply nested 'game.recalc' with a clean, linear version.

game.recalc = () => {
    // --- V1 BASE STATS ---
    let d = 10 + (mathFix.safe(G.upg.dmg) * 2) + (G.lvl * 2);
    let h = 100 + (mathFix.safe(G.upg.hp) * 20) + (G.lvl * 10);
    
    // --- V5 GEM MULTIPLIERS ---
    if(G.perm.g_dmg) d *= 1.5;
    
    // --- V7 SPELL MULTIPLIERS ---
    if(G.spells) {
        let dmgMul = 1, hpMul = 1;
        magic.spells.forEach(s => {
            let lvl = G.spells[s.id] || 0;
            if(lvl > 0) {
                if(s.stat === 'dmg') dmgMul += (s.val * lvl);
                if(s.stat === 'hp') hpMul += (s.val * lvl);
            }
        });
        d *= dmgMul;
        h *= hpMul;
    }

    // --- V7 BLOOD PACTS ---
    if(G.pacts) d *= (1 + (G.pacts * 0.2));
    if(G.pacts) h *= 0.9; // Penalty

    // --- V13 VOID MULTIPLIERS ---
    if(G.void_upg && G.void_upg.v_str) {
        d *= Math.pow(2, G.void_upg.v_str);
    }
    
    // --- V14 CARD BONUSES ---
    if(cards && cards.getBonus) {
        d *= cards.getBonus();
    }

    // APPLY FINAL STATS
    G.stats.dmg = Math.floor(d);
    G.stats.hp = Math.floor(h);
    
    // Sanity Check (Prevent 0 HP max)
    if(G.stats.hp < 10) G.stats.hp = 10;
};

// 4. FIXING V5 AUTO-MINER & REGEN
// Previous versions often overwrote the setInterval logic. 
// We create a dedicated "Logic Ticker" that runs independently of the UI.
clearInterval(game.logicInterval); // Clear any old intervals
game.logicInterval = setInterval(() => {
    
    // A. REGENERATION (V1)
    if(G.upg.regen > 0) {
        if(S.hp < G.stats.hp) S.hp = Math.min(G.stats.hp, S.hp + G.upg.regen);
    }
    if(S.mp < G.stats.mp) S.mp += 1;

    // B. AUTO-MINER (V5)
    if(G.perm.g_auto > 0) {
        mining.hit(true); 
    }
    
    // C. PETS (V5)
    if(G.activePet && S.m_hp > 0 && !dungeon.active) {
        let pdmg = Math.floor(G.stats.dmg * 0.5);
        // Direct damage without triggering full combat loop to save perf
        S.m_hp -= pdmg;
        if(S.m_hp <= 0) combat.win();
    }
    
    // D. COOLDOWNS
    if(S.cd.blast > 0) S.cd.blast -= 1000; // 1 sec tick
    if(S.cd.heal > 0) S.cd.heal -= 1000;

}, 1000); // Runs once per second (Low CPU usage)

// 5. RENDERING OPTIMIZATION (Throttling)
// The UI loop is now decoupled from logic. It only updates text.
// We override the recursive `ui.loop` with a clean master render function.

ui.loop = () => {
    // 1. Update Resource Text (Using V18 formatter)
    let els = {
        gold: document.getElementById('hud-gold'),
        gem: document.getElementById('hud-gem'),
        lvl: document.getElementById('hud-lvl'),
        stage: document.getElementById('hud-stage'),
        hp: document.getElementById('bar-hp'),
        mp: document.getElementById('bar-mp'),
        xp: document.getElementById('xp-bar'),
        ehp: document.getElementById('bar-ehp')
    };

    if(els.gold) els.gold.innerText = fmt(G.gold);
    if(els.gem) els.gem.innerText = fmt(G.gems);
    if(els.lvl) els.lvl.innerText = G.lvl;
    
    // Dynamic Stage Text (Handle Dungeon/Raid text overrides)
    if(els.stage && !dungeon.active && !raid.active) els.stage.innerText = G.stage;

    // 2. Update Bars (Use CSS transform for performance instead of width)
    if(els.hp) els.hp.style.width = Math.max(0, (S.hp / G.stats.hp) * 100) + "%";
    if(els.mp) els.mp.style.width = Math.max(0, (S.mp / G.stats.mp) * 100) + "%";
    if(els.ehp) els.ehp.style.width = Math.max(0, (S.m_hp / S.m_max) * 100) + "%";
    if(els.xp) els.xp.style.width = Math.max(0, (G.xp / G.max_xp) * 100) + "%";

    // 3. Conditional Updates (Only update if tab is active to save battery)
    // We check which tab is visible by class
    if(document.getElementById('tab-mine').classList.contains('show')) {
        document.getElementById('mine-ore').innerText = fmt(G.mine.ore);
        document.getElementById('rock-bar').style.width = (S.rock_hp/S.rock_max*100)+"%";
    }
};

// 6. FINAL SAVE SANITIZER
// Runs on load to ensure no data corruption exists from older versions
const finalSanitize = () => {
    // Ensure all objects exist
    if(!G.upg) G.upg = { dmg:0, hp:0, regen:0, greed:0 };
    if(!G.perm) G.perm = { g_dmg:0, g_xp:0, g_auto:0 };
    if(!G.stats) G.stats = { dmg: 10, hp: 100, mp: 50 };
    
    // Fix NaNs
    G.gold = mathFix.safe(G.gold);
    G.gems = mathFix.safe(G.gems);
    G.lvl = Math.max(1, mathFix.safe(G.lvl));
    
    // Recalculate stats immediately to sync UI
    game.recalc();
    
    // Heal up just in case
    if(S.hp <= 0) S.hp = G.stats.hp;
};

// Run Sanitize immediately
finalSanitize();

console.log("%c V23: OPTIMIZATION COMPLETE. READY FOR RELEASE. ", "background: #2ecc71; color: #000; font-size: 14px; padding: 5px; border-radius: 4px;");

</script>
<script>
/* =========================================
   V24: THE FINAL CUT (RELEASE STABILIZATION)
   ========================================= */

console.log("%c FINALIZING BUILD FOR RELEASE... ", "background: #fff; color: #000; font-weight: bold; padding: 5px;");

// 1. STATE MANAGEMENT (Fixing V6/V13/V16 Conflict)
// The Dungeon, Raid, and Explorer modes often fought for control. 
// We explicitly define which mode is active to prevent overlap.

const gameState = {
    isDungeon: () => dungeon.active,
    isRaid: () => raid.active,
    isAFK: () => settings.data.afk,
    isExploring: () => explorer && explorer.active,
    isShopping: () => document.getElementById('tab-upg').classList.contains('show')
};

// 2. DEFINITIVE COMBAT WIN (Replacing V1 through V23 Wrappers)
// This removes the "wrapper hell" and executes all logic linearly and efficiently.

combat.win = () => {
    // A. STOP TIMERS
    clearInterval(S.boss_tmr); // Stop V1/V6 Boss Timer

    // B. CALCULATE REWARDS
    // Base V1
    let gold = Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1));
    let xp = 20 + (G.stage * 5);

    // Multipliers (V5, V11, V12)
    if(G.perm.g_xp) xp *= 1.5; 
    if(village.state === 'night') xp += (20 + G.stage * 5); 
    if(G.guild_lvl >= 1) gold += Math.floor((10 + G.stage) * 0.1); 

    // Apply & Visuals
    G.gold += gold;
    G.xp += xp;
    
    // Performance: Only float text if not in AFK mode (saves battery)
    if(!gameState.isAFK()) {
        fx.float("+"+fmt(gold)+"g", "#f1c40f", "hero");
        audio.play('coin'); // V10 Fixed Audio
    }

    // C. PROGRESSION (Level Up)
    if(G.xp >= G.max_xp) {
        G.lvl++; G.xp=0; G.max_xp *= 1.2;
        game.recalc();
        S.hp = G.stats.hp;
        if(!gameState.isAFK()) {
            fx.float("LEVEL UP!", "#3498db", "hero");
            audio.play('level');
        }
    }

    // D. RNG DROPS (Consolidated)
    let rng = Math.random();
    // Gems (V5)
    if(rng < ((G.stage%5===0)?0.05:0.001)) { G.gems++; fx.float("üíé GEM!", "#e84393", "hero"); }
    // Runes (V7)
    if(rng < 0.3) { let t = rng<0.1?'fire':(rng<0.2?'ice':'storm'); G.runes[t]++; }
    // Seeds (V11)
    if(rng < 0.2) G.seeds++;
    // Cards (V14)
    if(cards && cards.checkDrop) cards.checkDrop();

    // E. QUESTS (V7)
    if(quests && quests.check) {
        quests.check('kill', 1);
        quests.check('gold', gold);
    }

    // --- CRITICAL STATE LOGIC ---

    // 1. ENDING (V15)
    if(G.stage === 100 && !gameState.isDungeon()) {
        sys.triggerEnding();
        return;
    }

    // 2. DUNGEON / RAID LOGIC (V6 / V12)
    if(gameState.isDungeon() || gameState.isRaid()) {
        // Do NOT increment stage. Do NOT switch UI.
        // The dungeon logic handles the next spawn.
        if(dungeon.active) dungeon.nextWave();
        return; 
    }

    // 3. STANDARD GAMEPLAY
    G.stage++;

    // 4. NEXT ACTION DECIDER
    if (gameState.isAFK()) {
        // V17: Fast AFK Re-spawn
        setTimeout(combat.spawn, 500); // Fast spawn
    } else {
        // V16: Enable Map/Explorer
        // This fixes V8 animation glitching by ensuring we don't "Run" if we are exploring a grid
        explorer.enable();
    }
};

// 3. FIXING V6 DUNGEON LOGIC
// V6 used 'confirm' prompts which paused code execution. V13 added animations.
// This overrides both to ensure smooth, non-blocking entry.

dungeon.enter = () => {
    if(dungeon.active) return;
    
    // UI Feedback
    if(!confirm("Enter Boss Rush? (High difficulty, High reward)")) return;

    // Visual Transition (V13 Gate)
    visual.enterDungeon("BOSS RUSH", () => {
        // State Set
        dungeon.active = true;
        dungeon.wave = 1;

        // UI Clean up
        document.getElementById('d-pad').style.display = 'none'; // Hide V16
        document.getElementById('radar').style.display = 'none'; // Hide V16
        ui.tab('fight', document.querySelector('.nav-btn')); // Force fight screen

        // Start
        dungeon.nextWave();
    });
};

dungeon.win = () => {
    dungeon.active = false;
    G.gold += 50000;
    G.gems += 5;
    G.xp += G.max_xp; 
    
    alert("DUNGEON CLEARED!\n+50k Gold, +5 Gems");
    
    // Return to World Logic
    explorer.enable();
};

// 4. FIXING V8/V9 ANIMATION STACKING
// When attack speed gets high, animations overlap and look glitchy.
// We throttle the animations.

combat.deal = (amt, col) => {
    // 1. DATA UPDATE
    // Critical hit logic moved here for cleanliness
    let isCrit = Math.random() < 0.2;
    if(isCrit) { amt *= 2; col = "#e84393"; }

    S.m_hp -= amt;
    
    // 2. VISUALS (Throttled)
    // Only animate if the hero isn't already animating to prevent "vibrating"
    let h = document.querySelector('#hero .f-icon');
    if(!h.classList.contains('move-dash')) {
        h.classList.add('move-dash');
        setTimeout(() => h.classList.remove('move-dash'), 200);
    }
    
    // Particles (V9) - Limit count
    if(settings.data.part && document.getElementsByClassName('spark').length < 15) {
        spawnParticles(col);
    }
    
    // Sound (V10) - Debounce (don't play more than once every 50ms)
    let now = Date.now();
    if(now - (combat.lastSound||0) > 50) {
        audio.play('hit');
        combat.lastSound = now;
    }

    // Float Text
    fx.float(amt + (isCrit?"!":""), col, 'enemy');

    // Win Condition
    if(S.m_hp <= 0) combat.win();
    else if(Math.random() < 0.3) combat.enemyHit();
};

// 5. FINAL DOM OPTIMIZATION
// We inject a CSS class to force GPU acceleration on moving parts.
document.head.insertAdjacentHTML("beforeend", `
    <style>
        .fighter, .floater, .spark, .rain-drop { 
            transform: translate3d(0,0,0); /* Force GPU */
            backface-visibility: hidden;
        }
        /* Fix V16 Map Grid overlap */
        .map-grid { gap: 0; border: 2px solid #333; } 
    </style>
`);

// 6. AUTO-SAVE ON TAB CLOSE
// Modern browsers allow 'visibilitychange' to save before closing.
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
        game.save();
        console.log("Auto-saved on tab switch.");
    }
});

console.log("%c V24: READY FOR DEPLOYMENT ", "background: #2ecc71; color: #000; font-size: 16px; font-weight: bold; padding: 10px; border-radius: 4px;");

</script>
<script>
console.log("%c APPLYING V25 FINAL POLISH... ", "background: #fff; color: #000; font-size: 16px; font-weight: bold;");

// 1. DATA STRUCTURE PATCHER
// This runs immediately to ensure old save files don't crash the new features.
const patchSave = () => {
    // Ensure Village Data exists (V11)
    if (!G.seeds) G.seeds = 0;
    // Ensure Plots are valid
    if (!village.plots || village.plots.length === 0) {
        village.plots = [
            { active: false, timer: 0, max: 100, type: 'apple' },
            { active: false, timer: 0, max: 100, type: 'apple' },
            { active: false, timer: 0, max: 100, type: 'apple' }
        ];
    }
    // Ensure Map Data exists (V16)
    if (!explorer.map || explorer.map.length === 0) explorer.initMap();
    
    // Ensure Cards exist (V14)
    if (!G.cards) G.cards = {};
    
    console.log("Save Data Patched & Verified.");
};

// 2. OPTIMIZED WEATHER (Fixes V11 Lag)
// Replaces the old rain logic to prevent infinite DOM growth.
village.makeRain = () => {
    if (village.state !== 'rain') return;
    
    // Performance Cap: Max 20 rain drops on screen
    if (document.querySelectorAll('.rain-drop').length > 20) return;

    let d = document.createElement('div');
    d.className = 'rain-drop';
    d.style.left = Math.random() * 100 + "vw";
    d.style.animationDuration = (0.5 + Math.random() * 0.5) + "s";
    
    // GPU Acceleration Hint
    d.style.willChange = "transform";
    
    document.body.appendChild(d);
    
    // Auto-cleanup after animation
    setTimeout(() => { if(d.parentNode) d.remove(); }, 1000);
    
    // Recursion with check
    if(village.state === 'rain') setTimeout(village.makeRain, 100);
};

// 3. ASCENSION LOGIC OVERRIDE (Fixes V13 Reset)
// Previous versions forgot to reset the Farm and Map when Ascending.
voidSys.ascend = () => {
    let gain = voidSys.calcGain();
    if (gain <= 0) return alert("Reach Stage 100 first!");

    if (confirm(`Reset world for ${gain} Void Shards?`)) {
        // 1. Define what we KEEP
        let keep = {
            gems: G.gems,
            void_shards: (G.void_shards || 0) + gain,
            void_upg: G.void_upg || {},
            guild_lvl: G.guild_lvl,
            guild_xp: G.guild_xp,
            pets: G.pets,
            activePet: G.activePet,
            cards: G.cards,       // Keep Cards (V14)
            settings: G.settings,
            tutorials: G.tutorials,
            pacts: G.pacts,
            // DO NOT KEEP: seeds, farm plots, current map location
        };

        // 2. RESET G
        G = {
            gold: 0, lvl: 1, xp: 0, max_xp: 100,
            stage: 1 + (keep.void_upg.v_start || 0) * 10,
            stats: { dmg: 10, hp: 100, mp: 50 },
            
            upg: { dmg: 0, hp: 0, regen: 0, greed: 0 },
            perm: { g_dmg: 0, g_xp: 0, g_auto: 0 },
            mine: { ore: 0, lvl: 1, xp: 0 },
            runes: { fire: 0, ice: 0, storm: 0 },
            spells: {},
            quests: [],
            seeds: 0, // Reset seeds

            ...keep // Merge kept data
        };

        // 3. SYSTEM RESETS
        quests.gen();
        
        // Reset Farming (Fixes V11 Bug)
        village.plots = [
            { active: false, timer: 0, max: 100, type: 'apple' },
            { active: false, timer: 0, max: 100, type: 'apple' },
            { active: false, timer: 0, max: 100, type: 'apple' }
        ];
        
        // Reset Explorer Map (Fixes V16 Bug)
        explorer.initMap(); 

        // 4. ANIMATION & RELOAD
        visual.enterDungeon("ASCENSION", () => {
            game.save();
            location.reload();
        });
    }
};

// 4. UI CLEANUP HOOK
// Ensures that when we switch tabs, we clean up heavy elements from other tabs.
const tabFinal = ui.tab;
ui.tab = (id, btn) => {
    // Stop Rain if leaving Village (Performance)
    if (id !== 'village' && village.state === 'rain') {
        // Force stop visual rain
        let drops = document.querySelectorAll('.rain-drop');
        drops.forEach(d => d.remove());
    }
    
    // Stop Raid UI if leaving Fight
    if (id !== 'fight' && !dungeon.active) {
        document.getElementById('raid-ui').style.display = 'none';
    } else if (id === 'fight' && raid.active) {
        document.getElementById('raid-ui').style.display = 'block';
    }

    // Run original logic
    tabFinal(id, btn);
};

// 5. FINAL INITIALIZATION
// Run the patcher
patchSave();

// Add a final CSS polish for the loading screen/text
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* Better Tooltips */
    [title] { position: relative; cursor: help; }
    
    /* Responsive Text Fixes */
    @media (max-width: 600px) {
        .hud { font-size: 10px; padding: 5px; }
        .nav-btn { font-size: 8px; }
        .btn { font-size: 10px; }
    }
    
    /* V25 Polish */
    #version-display {
        position: fixed; bottom: 5px; left: 5px; 
        font-size: 8px; color: #444; z-index: 9999;
        font-family: 'Roboto Mono', monospace;
    }
</style>
`);

// Add visible version tag
let verTag = document.createElement('div');
verTag.id = 'version-display';
verTag.innerText = "v1.0.0 (Build 25)";
document.body.appendChild(verTag);

console.log("GAME IS GOLD. READY TO PLAY.");
</script>
<script>
/* =========================================
   V26: GOLD MASTER (FINAL RELEASE PATCH)
   ========================================= */

console.log("%c FINAL SYSTEM PURGE & INITIALIZATION ", "background: #e74c3c; color: #fff; font-size: 20px; font-weight: bold;");

// ------------------------------------------------
// 1. SYSTEM CLEANUP (Kill Zombies)
// ------------------------------------------------
// This brute-forces clearing all previous intervals to prevent
// V1, V5, and V23 loops from running simultaneously.
let highestId = window.setInterval(";");
for (let i = 0; i < highestId; i++) {
    window.clearInterval(i);
}
console.log("Legacy background threads terminated.");

// ------------------------------------------------
// 2. UNIFIED STATE MANAGER (Fixes V14/V16/V17 Conflicts)
// ------------------------------------------------
const State = {
    current: 'IDLE', // IDLE, COMBAT, DUNGEON, RAID, EXPLORE, AFK
    
    check: () => {
        // Priority Hierarchy
        if(dungeon.active) return 'DUNGEON';
        if(raid.active) return 'RAID';
        if(settings.data.afk) return 'AFK';
        if(explorer && explorer.active) return 'EXPLORE';
        return 'IDLE'; // Default state (allows V14 Walk button or V16 Grid)
    },

    updateUI: () => {
        let s = State.check();
        let dpad = document.getElementById('d-pad');
        let radar = document.getElementById('radar');
        let walkBtn = document.getElementById('walk-ui');
        let autoBtn = document.getElementById('btn-autowalk'); // V14 Auto Toggle

        // 1. Handle D-Pad / Radar (V16)
        if (s === 'EXPLORE') {
            if(dpad) dpad.style.display = 'grid';
            if(radar) radar.style.display = 'grid';
            if(walkBtn) walkBtn.style.display = 'none'; // Hide Walk button if exploring
        } else {
            if(dpad) dpad.style.display = 'none';
            if(radar) radar.style.display = 'none';
        }

        // 2. Handle Walk Button (V14)
        // Only show if IDLE and not in a dungeon
        if (s === 'IDLE' && travel.waiting && !dungeon.active) {
            if(walkBtn) walkBtn.style.display = 'block';
        } else {
            if(walkBtn) walkBtn.style.display = 'none';
        }

        // 3. Handle Auto-Walk Text (V17 vs V14)
        if(s === 'AFK') {
             if(autoBtn) {
                 autoBtn.classList.add('on');
                 autoBtn.innerText = "AFK MODE ACTIVE";
             }
        }
    }
};

// ------------------------------------------------
// 3. THE DEFINITIVE GAME LOOP (Optimized)
// ------------------------------------------------
// Replaces all previous loops. Logic runs at 10 ticks/sec.
// Rendering runs at 60fps (via requestAnimationFrame).

let lastTick = 0;
const MasterLoop = (timestamp) => {
    // A. LOGIC THROTTLE (100ms / 10Hz)
    if (timestamp - lastTick >= 100) {
        lastTick = timestamp;
        G.ticks++;
        
        // 1. Resources
        if(S.mp < G.stats.mp) S.mp++;
        if(G.upg.regen > 0 && S.hp < G.stats.hp) S.hp = Math.min(G.stats.hp, S.hp + G.upg.regen);
        
        // 2. Cooldowns
        if(S.cd.blast > 0) S.cd.blast -= 100;
        if(S.cd.heal > 0) S.cd.heal -= 100;

        // 3. Auto-Miner (V5)
        if(G.perm.g_auto) mining.hit(true);
        
        // 4. Pets (V5)
        if(G.activePet && S.m_hp > 0 && !dungeon.active) {
             // Direct logic to avoid lag
             S.m_hp -= Math.floor(G.stats.dmg * 0.5);
             if(S.m_hp <= 0) combat.win();
        }

        // 5. Village Weather (V11)
        if(G.ticks % 50 === 0) village.tickEnv();
        farming.tick();

        // 6. Save (Every 30s)
        if(G.ticks % 300 === 0) game.save();
    }

    // B. RENDER (Every Frame)
    ui.renderFrame();
    
    // Loop
    requestAnimationFrame(MasterLoop);
};

// ------------------------------------------------
// 4. RENDERER (Clean UI Updates)
// ------------------------------------------------
ui.renderFrame = () => {
    // Core Stats
    document.getElementById('hud-gold').innerText = fmt(G.gold);
    document.getElementById('hud-gem').innerText = fmt(G.gems);
    
    // Bars (Using Transforms for Performance)
    const setBar = (id, cur, max) => {
        let el = document.getElementById(id);
        if(el) el.style.transform = `scaleX(${Math.max(0, cur/max)})`; // Better than width
        if(el) el.style.transformOrigin = "left"; // Ensure it shrinks to left
    };
    
    // We apply style.width for compatibility with CSS transitions defined earlier
    document.getElementById('bar-hp').style.width = (S.hp/G.stats.hp*100)+"%";
    document.getElementById('bar-mp').style.width = (S.mp/G.stats.mp*100)+"%";
    document.getElementById('bar-ehp').style.width = (S.m_hp/S.m_max*100)+"%";
    
    // UI State Check
    State.updateUI();
};

// ------------------------------------------------
// 5. DEFINITIVE COMBAT WIN (The Router)
// ------------------------------------------------
combat.win = () => {
    // 1. Stop Timers
    clearInterval(S.boss_tmr);

    // 2. Rewards
    let gold = Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1));
    if(G.guild_lvl >= 1) gold += Math.floor((10 + G.stage) * 0.1);
    
    let xp = 20 + (G.stage * 5);
    if(village.state === 'night') xp *= 2;

    G.gold += gold;
    G.xp += xp;

    // 3. Level Up
    if(G.xp >= G.max_xp) {
        G.lvl++; G.xp=0; G.max_xp *= 1.2;
        game.recalc();
        S.hp = G.stats.hp;
        if(!settings.data.afk) {
            fx.float("LEVEL UP!", "#3498db", "hero");
            audio.play('level');
        }
    } else {
        if(!settings.data.afk) {
            fx.float("+"+fmt(gold), "#f1c40f", "hero");
            audio.play('coin');
        }
    }

    // 4. RNG Drops
    if(Math.random() < 0.01) G.gems++;
    if(cards) cards.checkDrop();

    // 5. DECIDE NEXT STEP (The Fix)
    let s = State.check();

    if(s === 'DUNGEON' || s === 'RAID') {
        if(dungeon.active) dungeon.nextWave();
        return; 
    }
    
    if(G.stage === 100) { sys.triggerEnding(); return; }

    G.stage++;

    if(s === 'AFK') {
        setTimeout(combat.spawn, 250); // Fast spawn
    } else {
        // Return to Explorer Mode (V16 Grid)
        explorer.enable();
    }
};

// ------------------------------------------------
// 6. DATA SANITIZER (Deep Check)
// ------------------------------------------------
const sanitize = () => {
    // Deep merge defaults to ensure no "undefined" crashes
    const def = {
        gold: 10, lvl: 1, xp: 0, stage: 1, 
        stats: { dmg: 10, hp: 100, mp: 50 },
        upg: { dmg:0, hp:0, regen:0, greed:0 },
        perm: { g_dmg:0, g_xp:0, g_auto:0 },
        runes: { fire:0, ice:0, storm:0 },
        mine: { ore:0, lvl:1, xp:0 },
        cards: {}, settings: { sfx:true, part:true, afk:false }
    };

    // Helper: missing key filler
    for (let key in def) {
        if (G[key] === undefined) G[key] = def[key];
    }
    if(!G.settings) G.settings = def.settings;
    
    // Fix HP NaN
    if(isNaN(G.stats.hp) || G.stats.hp < 10) {
        G.stats.hp = 100; G.stats.dmg = 10;
        console.log("Stats repaired");
    }
    
    // Recalc final stats
    game.recalc();
    
    // Initialize Systems
    if(explorer && explorer.initMap) explorer.initMap();
    if(quests && quests.gen) quests.gen();
};

// ------------------------------------------------
// 7. FINAL BOOT SEQUENCE
// ------------------------------------------------
window.onload = () => {
    // 1. Hide Loader
    let loader = document.getElementById('loader');
    if(loader) loader.style.display = 'none';

    // 2. Load & Sanitize
    game.load();
    sanitize();

    // 3. Start Master Loop
    requestAnimationFrame(MasterLoop);

    // 4. Audio Init (Waiting for click)
    document.body.addEventListener('click', () => {
        if(safeAudio && safeAudio.init) safeAudio.init();
    }, { once: true });

    console.log("V26 GOLD MASTER LAUNCHED");
};

// Inject CSS Fixes for V16 Map alignment and Mobile Tap
document.head.insertAdjacentHTML("beforeend", `
<style>
    /* Final Mobile Tweaks */
    button { touch-action: manipulation; }
    .map-grid { border: 2px solid #555; background: #000; display:grid; }
    .tile { width: 100%; height: 100%; box-sizing: border-box; }
    /* Hide Walk Button by default to prevent flicker */
    #walk-ui { display: none; }
    /* Fix Bars Scaling */
    .bar-fill { transition: transform 0.1s linear; width: 100%; transform: scaleX(0); }
</style>
`);

</script>
<script>
/* =========================================
   V27: RELEASE GOLD (FINAL MASTER)
   ========================================= */

console.log("%c FINALIZING COSMIC RPG... ", "background: #fff; color: #000; font-size: 16px; font-weight: 900;");

// ------------------------------------------------
// 1. META & CSS INJECTION (Mobile & UI Fixes)
// ------------------------------------------------
// Fixes tiny text on mobile and prevents scrolling/bouncing
const meta = document.createElement('meta');
meta.name = "viewport";
meta.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover";
document.head.appendChild(meta);

document.head.insertAdjacentHTML("beforeend", `
<style>
    /* Fullscreen reset */
    html, body { 
        height: 100%; width: 100%; overflow: hidden; 
        background: #000; touch-action: none; 
    }
    
    /* Better button feedback */
    button:active, .btn:active, .dpad-btn:active {
        transform: scale(0.96) !important;
        filter: brightness(1.2);
    }
    
    /* Hide scrollbars completely */
    *::-webkit-scrollbar { display: none; }
    
    /* Emergency Reset Button (Bottom Left, invisible unless hovered/held) */
    #panic-btn {
        position: fixed; bottom: 0; left: 0; width: 30px; height: 30px;
        z-index: 99999; opacity: 0; cursor: pointer;
    }
</style>
`);

// ------------------------------------------------
// 2. THE NUCLEAR CLEANUP (Kill Zombies)
// ------------------------------------------------
// We capture the highest interval ID and clear everything below it.
// This ensures V1, V5, V11, V16 loops are DEAD.
const killZombies = () => {
    let id = window.setTimeout(function() {}, 0);
    while (id--) {
        window.clearTimeout(id); // Clears timeouts AND intervals
    }
    console.log("All background threads terminated.");
};
killZombies();

// ------------------------------------------------
// 3. THE "DOCTOR" (Save Repair)
// ------------------------------------------------
const TheDoctor = {
    heal: () => {
        // 1. Fix NaN Stats
        if (isNaN(G.gold)) G.gold = 0;
        if (isNaN(G.stats.hp) || G.stats.hp <= 0) G.stats.hp = 100;
        if (isNaN(G.stats.dmg)) G.stats.dmg = 10;
        
        // 2. Fix Missing Objects
        if (!G.cards) G.cards = {};
        if (!G.settings) G.settings = { sfx: true, part: true, afk: false };
        if (!G.upg) G.upg = { dmg: 0, hp: 0, regen: 0, greed: 0 };
        
        // 3. Fix Logic States
        // If saved inside a dungeon, kick them out (prevents soft lock)
        if (dungeon.active) {
            dungeon.active = false;
            ui.tab('fight', document.querySelector('.nav-btn'));
        }
        
        console.log("Save file integrity verified.");
    }
};

// ------------------------------------------------
// 4. THE MASTER LOOP (60 FPS Locked)
// ------------------------------------------------
// Replaces all other loops with a stable, battery-friendly heartbeat.
const Engine = {
    lastTime: 0,
    tickAccumulator: 0,
    TICK_RATE: 1000 / 10, // 10 Logic Ticks per second (100ms)
    
    start: () => {
        requestAnimationFrame(Engine.loop);
    },
    
    loop: (currentTime) => {
        const dt = currentTime - Engine.lastTime;
        Engine.lastTime = currentTime;
        
        // Logic Update (Fixed Time Step)
        Engine.tickAccumulator += dt;
        while (Engine.tickAccumulator >= Engine.TICK_RATE) {
            Engine.update(); // Run Game Logic
            Engine.tickAccumulator -= Engine.TICK_RATE;
        }
        
        // Render Update (Every Frame)
        Engine.render();
        
        requestAnimationFrame(Engine.loop);
    },
    
    // THE ONLY PLACE GAME LOGIC SHOULD RUN
    update: () => {
        G.ticks++;
        
        // 1. Resources
        if (S.mp < G.stats.mp) S.mp++;
        if (G.upg.regen > 0 && S.hp < G.stats.hp) S.hp += G.upg.regen;
        if (S.hp > G.stats.hp) S.hp = G.stats.hp; // Cap HP
        
        // 2. Cooldowns
        if (S.cd.blast > 0) S.cd.blast -= 100;
        if (S.cd.heal > 0) S.cd.heal -= 100;
        
        // 3. Auto Systems
        if (G.perm.g_auto) mining.hit(true);
        if (village.plots) farming.tick();
        if (G.ticks % 50 === 0) village.tickEnv(); // Weather
        
        // 4. Combat Ticks (Auto-Attack / Pets)
        if (G.activePet && !dungeon.active && !raid.active && S.m_hp > 0) {
            S.m_hp -= Math.floor(G.stats.dmg * 0.2); // Pet does 20% DPS
            if (S.m_hp <= 0) combat.win();
        }
        
        // 5. Auto Save (30s)
        if (G.ticks % 300 === 0) game.save();
    },
    
    // THE ONLY PLACE UI UPDATES SHOULD RUN
    render: () => {
        // Only update text that changed
        document.getElementById('hud-gold').innerText = fmt(G.gold);
        document.getElementById('hud-gem').innerText = fmt(G.gems);
        
        // Bars
        const hpPct = (S.hp / G.stats.hp) * 100;
        document.getElementById('bar-hp').style.width = hpPct + "%";
        document.getElementById('bar-mp').style.width = (S.mp / G.stats.mp * 100) + "%";
        document.getElementById('bar-ehp').style.width = (S.m_hp / S.m_max * 100) + "%";
        
        // State Management UI
        const isExplore = (explorer && explorer.active);
        const isAFK = (settings.data.afk);
        
        // Force V16 Grid visibility
        const mapTab = document.getElementById('d-pad');
        if (mapTab) mapTab.style.display = (isExplore && !isAFK) ? 'grid' : 'none';
        
        // Force V14 Button visibility
        const walkBtn = document.getElementById('walk-ui');
        if (walkBtn) walkBtn.style.display = 'none'; // Deprecated in favor of Explorer/AFK
    }
};

// ------------------------------------------------
// 5. COMBAT RESOLVER (Fixing the Conflict)
// ------------------------------------------------
combat.win = () => {
    // 1. Rewards
    let gold = Math.floor((10 + G.stage) * (1 + G.upg.greed * 0.1));
    if (G.guild_lvl >= 1) gold += Math.floor((10 + G.stage) * 0.1);
    let xp = 20 + (G.stage * 5);
    
    G.gold += gold;
    G.xp += xp;

    // 2. Level Up
    if (G.xp >= G.max_xp) {
        G.lvl++; G.xp = 0; G.max_xp *= 1.2;
        game.recalc();
        S.hp = G.stats.hp;
        if (!settings.data.afk) {
            fx.float("LEVEL UP!", "#3498db", "hero");
            audio.play('level');
        }
    }

    // 3. Loot Logic
    if (Math.random() < 0.01) G.gems++;
    if (cards) cards.checkDrop();

    // 4. STATE MACHINE (Where to go next?)
    if (dungeon.active) { dungeon.nextWave(); return; }
    if (raid.active) { return; } // Raid handles itself
    
    if (G.stage === 100) { sys.triggerEnding(); return; }

    G.stage++; // Progress
    
    // 5. ACTION
    if (settings.data.afk) {
        // Fast Spawn for AFK
        setTimeout(combat.spawn, 500);
    } else {
        // Enable Explorer Mode (V16)
        explorer.enable(); 
    }
};

// ------------------------------------------------
// 6. INITIALIZATION SEQUENCE
// ------------------------------------------------
// Add Emergency Reset Button
document.body.insertAdjacentHTML('beforeend', `<div id="panic-btn" onclick="if(confirm('HARD RESET?')) game.hardReset()" title="Emergency Reset"></div>`);

window.onload = () => {
    // 1. Load Data
    game.load();
    TheDoctor.heal(); // Repair data
    game.recalc();
    
    // 2. Hide Loader
    let l = document.getElementById('loader');
    if (l) l.style.display = 'none';

    // 3. Init Systems
    if (explorer.initMap) explorer.initMap();
    if (quests.gen) quests.gen();
    
    // 4. Start Engine
    Engine.start();
    
    // 5. Audio Unlock Listener
    document.body.addEventListener('click', () => {
        if (safeAudio && safeAudio.init) safeAudio.init();
    }, { once: true });
    
    console.log("V27 GOLD MASTER: Systems Online.");
};

// ------------------------------------------------
// 7. FINAL OVERRIDES (Patching V25 bugs)
// ------------------------------------------------
// Fix V25 Rain Loop causing lag
village.makeRain = () => {
    if (village.state !== 'rain') return;
    if (document.querySelectorAll('.rain-drop').length > 15) return; // Strict Limit
    
    let d = document.createElement('div');
    d.className = 'rain-drop';
    d.style.left = Math.random() * 100 + "vw";
    d.style.animationDuration = (0.5 + Math.random()) + "s";
    document.body.appendChild(d);
    
    setTimeout(() => d.remove(), 1000);
    setTimeout(village.makeRain, 200);
};

</script>
